
# Factory Pattern System

Relevant source files

- [adeline/app/factories/sink_factory.py](https://github.com/acare7/kata-inference-251021-clean4/blob/a0662727/adeline/app/factories/sink_factory.py)
- [adeline/inference/factories/handler_factory.py](https://github.com/acare7/kata-inference-251021-clean4/blob/a0662727/adeline/inference/factories/handler_factory.py)
- [adeline/inference/factories/strategy_factory.py](https://github.com/acare7/kata-inference-251021-clean4/blob/a0662727/adeline/inference/factories/strategy_factory.py)

## Purpose and Scope

The Factory Pattern System is the component creation layer of the Adeline inference pipeline. This system consists of three specialized factories that construct pipeline components based on configuration:

- **InferenceHandlerFactory** - Creates inference handlers with ROI strategies
- **SinkFactory** - Creates output sinks with priority ordering
- **StrategyFactory** - Creates stabilization strategies

Each factory encapsulates complex construction logic, enabling the `PipelineBuilder` to orchestrate assembly without knowing implementation details. For information about how these factories are invoked during pipeline construction, see [PipelineBuilder](https://deepwiki.com/acare7/kata-inference-251021-clean4/3.2-pipelinebuilder). For details about individual factory implementations, see sections [3.3.1](https://deepwiki.com/acare7/kata-inference-251021-clean4/3.3.1-inferencehandlerfactory), [3.3.2](https://deepwiki.com/acare7/kata-inference-251021-clean4/3.3.2-sinkfactory), and [3.3.3](https://deepwiki.com/acare7/kata-inference-251021-clean4/3.3.3-strategyfactory).

## Factory Architecture Overview

The factory system implements a strict separation between **construction** (what to build) and **orchestration** (when to build). The `PipelineBuilder` orchestrates the construction sequence, while each factory determines which concrete implementation to instantiate based on configuration.



```mermaid
flowchart TD

%% Layers
subgraph conf["Configuration Layer"]
  CONFIG[AdelineConfig]
  ROI_MODE[roi.mode: none,adaptive,fixed]
  ENABLE_VIZ[pipeline.enable_visualization]
  STAB_MODE[stabilization.mode: none,temporal]
end

subgraph orch["Orchestration Layer"]
  PB[PipelineBuilder]
  BUILD_HANDLER[build_inference_handler]
  BUILD_SINKS[build_sinks]
  WRAP_STAB[wrap_sinks_with_stabilization]
end

subgraph fact["Factory Layer"]
  HF[InferenceHandlerFactory]
  SF[SinkFactory]
  STF[StrategyFactory]
end

subgraph comp["Component Layer"]
  HANDLER[BaseInferenceHandler; StandardInferenceHandler; AdaptiveInferenceHandler; FixedROIInferenceHandler]
  SINKS[List of callables; MQTT Sink; ROI Update Sink; Visualization Sink]
  STABILIZER[BaseDetectionStabilizer; NoOpStabilizer; TemporalHysteresisStabilizer]
end

%% Main flow
CONFIG --> PB
PB --> BUILD_HANDLER
PB --> BUILD_SINKS
PB --> WRAP_STAB

BUILD_HANDLER --> HF
BUILD_SINKS --> SF
WRAP_STAB --> STF

%% Config influences (dashed)
ROI_MODE -.->|determines| HF
ENABLE_VIZ -.->|determines| SF
STAB_MODE -.->|determines| STF

%% Factory to components
HF --> HANDLER
SF --> SINKS
STF --> STABILIZER
```

**Sources:** [adeline/inference/factories/handler_factory.py1-153](https://github.com/acare7/kata-inference-251021-clean4/blob/a0662727/adeline/inference/factories/handler_factory.py#L1-L153) [adeline/app/factories/sink_factory.py1-137](https://github.com/acare7/kata-inference-251021-clean4/blob/a0662727/adeline/app/factories/sink_factory.py#L1-L137) [adeline/inference/factories/strategy_factory.py1-77](https://github.com/acare7/kata-inference-251021-clean4/blob/a0662727/adeline/inference/factories/strategy_factory.py#L1-L77)

## Design Principles

The factory system adheres to these architectural principles:

|Principle|Implementation|Benefit|
|---|---|---|
|**Encapsulation**|Each factory contains all construction logic for its domain|`PipelineBuilder` doesn't need to know how components are built|
|**Configuration-Driven**|All decisions based on validated `AdelineConfig`|Type-safe, fail-fast construction|
|**Single Responsibility**|One factory per component type|Clear boundaries, easy to extend|
|**Registry Pattern**|`SinkFactory` uses `SinkRegistry` internally|Decoupled sink registration with explicit priorities|
|**Fail Fast**|Validation occurs at factory creation time|Errors surface immediately, not during runtime|

## The Three Factories

### Factory Responsibilities Matrix

|Factory|Input|Output|Configuration Keys|
|---|---|---|---|
|`InferenceHandlerFactory`|`AdelineConfig`|`(BaseInferenceHandler, Optional[ROIState])`|`roi.mode`, `roi.adaptive.*`, `roi.fixed.*`, `models.*`|
|`SinkFactory`|`AdelineConfig`, `MQTTDataPlane`, `Optional[ROIState]`, `Optional[InferenceHandler]`|`List[Callable]`|`pipeline.enable_visualization`, `pipeline.display_statistics`, `roi.mode`|
|`StrategyFactory`|`AdelineConfig`|`Optional[BaseDetectionStabilizer]`|`stabilization.mode`, `stabilization.temporal.*`, `stabilization.hysteresis.*`, `stabilization.iou.*`|

### InferenceHandlerFactory

Creates the appropriate inference handler based on ROI mode. This factory also creates and manages the `ROIState` object that tracks region of interest across frames.

**Decision Logic:**

```mermaid
flowchart TD
  CONFIG[config.roi.mode]
  STANDARD[StandardInferenceHandler]
  ADAPTIVE_PATH[Create ROIState]
  FIXED_PATH[Create FixedROIState]
  ADAPTIVE[AdaptiveInferenceHandler]
  FIXED[FixedROIInferenceHandler]
  RETURN_NONE[return handler, None]
  RETURN_ADAPTIVE[return handler, roi_state]
  RETURN_FIXED[return handler, roi_state]

  CONFIG -- none --> STANDARD
  CONFIG -- adaptive --> ADAPTIVE_PATH
  CONFIG -- fixed --> FIXED_PATH

  ADAPTIVE_PATH --> ADAPTIVE
  FIXED_PATH --> FIXED

  STANDARD -.->|no ROI state| RETURN_NONE
  ADAPTIVE -.->|with ROIState| RETURN_ADAPTIVE
  FIXED -.->|with FixedROIState| RETURN_FIXED
```

**Sources:** [adeline/inference/factories/handler_factory.py32-153](https://github.com/acare7/kata-inference-251021-clean4/blob/a0662727/adeline/inference/factories/handler_factory.py#L32-L153)

### SinkFactory

Creates output sinks with explicit priority ordering. Uses `SinkRegistry` internally to manage sink creation and composition.

**Sink Priority Order:**

|Priority|Sink Name|Factory Function|Condition|
|---|---|---|---|
|1|MQTT|`_create_mqtt_sink_factory`|Always created|
|50|ROI Update|`_create_roi_update_sink_factory`|Only if `config.roi.mode == 'adaptive'`|
|100|Visualization|`_create_visualization_sink_factory`|Only if `config.pipeline.enable_visualization == True`|

Lower priority numbers are created first. Priority 1 (MQTT sink) is wrapped by stabilization, ensuring filtered detections are published.

**Sources:** [adeline/app/factories/sink_factory.py71-137](https://github.com/acare7/kata-inference-251021-clean4/blob/a0662727/adeline/app/factories/sink_factory.py#L71-L137) [adeline/app/factories/sink_factory.py29-69](https://github.com/acare7/kata-inference-251021-clean4/blob/a0662727/adeline/app/factories/sink_factory.py#L29-L69)

### StrategyFactory

Creates stabilization strategies based on the configured mode. Returns `None` if stabilization is disabled.

**Decision Logic:**

```mermaid
flowchart LR
  CONFIG[config.stabilization.mode]
  NONE_RETURN[return None]
  CREATE_CONFIG[StabilizationConfig]
  FACTORY[create_stabilization_strategy]
  STABILIZER[TemporalHysteresisStabilizer]

  CONFIG -- none --> NONE_RETURN
  CONFIG -- temporal --> CREATE_CONFIG
  CREATE_CONFIG --> FACTORY
  FACTORY --> STABILIZER
```


**Sources:** [adeline/inference/factories/strategy_factory.py20-77](https://github.com/acare7/kata-inference-251021-clean4/blob/a0662727/adeline/inference/factories/strategy_factory.py#L20-L77)

## Code Entity Mapping

This diagram maps the factory system's natural language concepts to concrete code entities:

```mermaid
flowchart LR

subgraph Code Classes
  IHF[InferenceHandlerFactory adeline/inference/factories/handler_factory.py]
  SF[SinkFactory adeline/app/factories/sink_factory.py]
  STF[StrategyFactory adeline/inference/factories/strategy_factory.py]
  SR[SinkRegistry adeline/app/sinks/]
end

subgraph Factory Methods
  IHF_CREATE[InferenceHandlerFactory.create]
  SF_CREATE[SinkFactory.create_sinks]
  STF_CREATE[StrategyFactory.create_stabilization_strategy]
  MQTT_FACTORY[_create_mqtt_sink_factory]
  ROI_FACTORY[_create_roi_update_sink_factory]
  VIZ_FACTORY[_create_visualization_sink_factory]
end

subgraph Created Components
  STD_HANDLER[StandardInferenceHandler]
  ADAPT_HANDLER[AdaptiveInferenceHandler]
  FIXED_HANDLER[FixedROIInferenceHandler]
  MQTT_SINK[create_mqtt_sink]
  ROI_SINK[roi_update_sink]
  VIZ_SINK[create_visualization_sink]
  TEMPORAL_STAB[TemporalHysteresisStabilizer]
  NOOP_STAB[NoOpStabilizer]
end

IHF --> IHF_CREATE
SF --> SF_CREATE
STF --> STF_CREATE

SF_CREATE --> SR
SR --> MQTT_FACTORY
SR --> ROI_FACTORY
SR --> VIZ_FACTORY

MQTT_FACTORY --> MQTT_SINK
ROI_FACTORY --> ROI_SINK
VIZ_FACTORY --> VIZ_SINK

IHF_CREATE -. creates .-> STD_HANDLER
IHF_CREATE -. creates .-> ADAPT_HANDLER
IHF_CREATE -. creates .-> FIXED_HANDLER

STF_CREATE -. creates .-> TEMPORAL_STAB
STF_CREATE -. creates .-> NOOP_STAB
```

**Sources:** [adeline/inference/factories/handler_factory.py32-153](https://github.com/acare7/kata-inference-251021-clean4/blob/a0662727/adeline/inference/factories/handler_factory.py#L32-L153) [adeline/app/factories/sink_factory.py71-137](https://github.com/acare7/kata-inference-251021-clean4/blob/a0662727/adeline/app/factories/sink_factory.py#L71-L137) [adeline/inference/factories/strategy_factory.py36-77](https://github.com/acare7/kata-inference-251021-clean4/blob/a0662727/adeline/inference/factories/strategy_factory.py#L36-L77)

## Configuration-Driven Creation

Each factory receives a validated `AdelineConfig` object and extracts only the configuration parameters it needs. This table shows the configuration-to-factory mapping:

|Configuration Section|Factory|Key Parameters|
|---|---|---|
|`config.roi.mode`|`InferenceHandlerFactory`|Determines which handler class to instantiate|
|`config.roi.adaptive.*`|`InferenceHandlerFactory`|Parameters for `ROIState` construction|
|`config.roi.fixed.*`|`InferenceHandlerFactory`|Parameters for `FixedROIState` construction|
|`config.models.*`|`InferenceHandlerFactory`|Model loading parameters|
|`config.pipeline.enable_visualization`|`SinkFactory`|Determines if visualization sink is created|
|`config.stabilization.mode`|`StrategyFactory`|Determines if stabilization is enabled|
|`config.stabilization.temporal.*`|`StrategyFactory`|Temporal filtering parameters|
|`config.stabilization.hysteresis.*`|`StrategyFactory`|Hysteresis threshold parameters|
|`config.stabilization.iou.*`|`StrategyFactory`|IoU matching parameters|

**Sources:** [adeline/inference/factories/handler_factory.py49-153](https://github.com/acare7/kata-inference-251021-clean4/blob/a0662727/adeline/inference/factories/handler_factory.py#L49-L153) [adeline/app/factories/sink_factory.py84-136](https://github.com/acare7/kata-inference-251021-clean4/blob/a0662727/adeline/app/factories/sink_factory.py#L84-L136) [adeline/inference/factories/strategy_factory.py36-77](https://github.com/acare7/kata-inference-251021-clean4/blob/a0662727/adeline/inference/factories/strategy_factory.py#L36-L77)

## Interaction with PipelineBuilder

The `PipelineBuilder` invokes factories in a specific sequence to assemble the complete pipeline:


```mermaid
sequenceDiagram
participant PB as PipelineBuilder
participant HF as InferenceHandlerFactory
participant SF as SinkFactory
participant STF as StrategyFactory

Note over PB: Phase 1 - Build Handler
PB->>HF: create config
HF-->>PB: handler, roi_state

Note over PB: Phase 2 - Build Sinks
PB->>SF: create_sinks config data_plane roi_state handler
SF-->>PB: mqtt_sink roi_sink? viz_sink?

Note over PB: Phase 3 - Wrap Stabilization
PB->>STF: create_stabilization_strategy config
STF-->>PB: stabilizer or none
PB->>PB: wrap first sink with stabilizer

Note over PB: Phase 4 - Assemble Pipeline
PB->>PB: create InferencePipeline handler and sinks
```
**Sources:** [adeline/inference/factories/handler_factory.py49-153](https://github.com/acare7/kata-inference-251021-clean4/blob/a0662727/adeline/inference/factories/handler_factory.py#L49-L153) [adeline/app/factories/sink_factory.py84-136](https://github.com/acare7/kata-inference-251021-clean4/blob/a0662727/adeline/app/factories/sink_factory.py#L84-L136) [adeline/inference/factories/strategy_factory.py36-77](https://github.com/acare7/kata-inference-251021-clean4/blob/a0662727/adeline/inference/factories/strategy_factory.py#L36-L77)

## Factory Implementation Details

### InferenceHandlerFactory Static Method

The factory exposes a single static method `create()` that encapsulates all handler creation logic:

**Method Signature:**

```
@staticmethod
def create(config: Any) -> Tuple[BaseInferenceHandler, Optional[Any]]
```

**Return Values:**

- Tuple containing handler and optional ROI state
- ROI state is `None` for standard mode, `ROIState` for adaptive mode, `FixedROIState` for fixed mode

**Sources:** [adeline/inference/factories/handler_factory.py48-153](https://github.com/acare7/kata-inference-251021-clean4/blob/a0662727/adeline/inference/factories/handler_factory.py#L48-L153)

### SinkFactory Registry Pattern

The `SinkFactory` uses the registry pattern internally to decouple sink creation:

```mermaid
flowchart LR
  %% SinkFactory wires up a SinkRegistry and registers sink factories

  SF["SinkFactory.create_sinks()"]
  SR["SinkRegistry"]
  REG["registry.register()"]

  MQTT_REG["name='mqtt', priority=1"]
  ROI_REG["name='roi_update', priority=50"]
  VIZ_REG["name='visualization', priority=100"]

  MQTT_FN["_create_mqtt_sink_factory"]
  ROI_FN["_create_roi_update_sink_factory"]
  VIZ_FN["_create_visualization_sink_factory"]

  CREATE_ALL["registry.create_all()"]
  SINKS["List[Callable]"]

  %% 1) Create instance
  SF -->|1. Create instance| SR

  %% 2) Register factories
  SF -->|2. Register factories| REG
  REG --> MQTT_REG
  REG --> ROI_REG
  REG --> VIZ_REG

  %% registry entries reference factory functions
  MQTT_REG -.->|factory function| MQTT_FN
  ROI_REG  -.->|factory function| ROI_FN
  VIZ_REG  -.->|factory function| VIZ_FN

  %% 3) Create all + return
  SF -->|3. Create all| CREATE_ALL
  CREATE_ALL -->|Returns| SINKS
```

Factory functions return `None` if the sink should not be created, allowing conditional sink creation without complex branching logic.

**Sources:** [adeline/app/factories/sink_factory.py84-136](https://github.com/acare7/kata-inference-251021-clean4/blob/a0662727/adeline/app/factories/sink_factory.py#L84-L136) [adeline/app/factories/sink_factory.py29-69](https://github.com/acare7/kata-inference-251021-clean4/blob/a0662727/adeline/app/factories/sink_factory.py#L29-L69)

### StrategyFactory Configuration Validation

The `StrategyFactory` creates a `StabilizationConfig` object before invoking the stabilization factory function. This ensures all parameters are validated before construction begins:

**Configuration Object Creation:**

```
stab_config = StabilizationConfig(
    mode=config.STABILIZATION_MODE,
    temporal_min_frames=config.STABILIZATION_MIN_FRAMES,
    temporal_max_gap=config.STABILIZATION_MAX_GAP,
    hysteresis_appear_conf=config.STABILIZATION_APPEAR_CONF,
    hysteresis_persist_conf=config.STABILIZATION_PERSIST_CONF,
    iou_threshold=config.STABILIZATION_IOU_THRESHOLD,
)
```

This configuration object is then passed to `create_stabilization_strategy()`, which constructs the appropriate stabilizer implementation.

**Sources:** [adeline/inference/factories/strategy_factory.py62-76](https://github.com/acare7/kata-inference-251021-clean4/blob/a0662727/adeline/inference/factories/strategy_factory.py#L62-L76)

## Extension Points

The factory system is designed for extension:

|Extension Point|How to Extend|
|---|---|
|**New ROI Mode**|Add new mode to `InferenceHandlerFactory.create()` and create new handler class|
|**New Sink Type**|Add new factory function and register with `SinkRegistry` in `SinkFactory.create_sinks()`|
|**New Stabilization Strategy**|Add new mode to `StrategyFactory.create_stabilization_strategy()` and implement `BaseDetectionStabilizer`|

Each factory follows the same pattern: configuration determines which concrete class to instantiate, and the factory encapsulates all construction complexity.

**Sources:** [adeline/inference/factories/handler_factory.py1-153](https://github.com/acare7/kata-inference-251021-clean4/blob/a0662727/adeline/inference/factories/handler_factory.py#L1-L153) [adeline/app/factories/sink_factory.py1-137](https://github.com/acare7/kata-inference-251021-clean4/blob/a0662727/adeline/app/factories/sink_factory.py#L1-L137) [adeline/inference/factories/strategy_factory.py1-77](https://github.com/acare7/kata-inference-251021-clean4/blob/a0662727/adeline/inference/factories/strategy_factory.py#L1-L77)