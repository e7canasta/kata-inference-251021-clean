# Infrastructure Services

Relevant source files

- [Makefile](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/Makefile)
- [README.md](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/README.md)
- [adeline/CLAUDE.md](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md)

## Purpose and Scope

This document describes the external infrastructure services required by the Adeline inference system and how to manage them. These services provide messaging, video streaming, and container orchestration capabilities that the inference pipeline depends on.

For information about the MQTT communication architecture and topic structure, see [MQTT Communication Architecture](https://deepwiki.com/care-foundation/kata-inference-251021-clean2/3.2-mqtt-communication-architecture). For service monitoring and health checks, see [Monitoring and Data Streams](https://deepwiki.com/care-foundation/kata-inference-251021-clean2/7.3-monitoring-and-data-streams). For Makefile automation commands, see [Makefile Command Reference](https://deepwiki.com/care-foundation/kata-inference-251021-clean2/7.1-makefile-command-reference).

---

## Infrastructure Overview

The Adeline inference system requires two primary external services:

|Service|Purpose|Default Endpoint|Configuration File|
|---|---|---|---|
|**MQTT Broker (Mosquitto)**|Message broker for control/data planes|`localhost:1883`|[docker/adeline/docker-compose.mqtt.yml](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/docker/adeline/docker-compose.mqtt.yml)|
|**go2rtc RTSP Proxy**|RTSP stream proxy and transcoding|User-configured|[config/adeline/go2rtc.yaml](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/config/adeline/go2rtc.yaml)|

Both services run as Docker containers managed via Docker Compose, providing isolated, reproducible deployments.

**Sources:** [Makefile130-151](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/Makefile#L130-L151) [README.md181-200](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/README.md#L181-L200) [adeline/CLAUDE.md1-143](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L1-L143)

---

## Service Architecture

**Diagram: Infrastructure Service Dependencies and Connections**

This diagram shows how `make services-up` orchestrates Docker Compose to start Mosquitto, and how Python components connect to the running broker. The go2rtc service is optional and user-managed separately.

**Sources:** [Makefile130-151](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/Makefile#L130-L151) [docker/adeline/docker-compose.mqtt.yml](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/docker/adeline/docker-compose.mqtt.yml) [adeline/CLAUDE.md21-43](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L21-L43)

---

## MQTT Broker (Mosquitto)

### Service Configuration

The MQTT broker is defined in the Docker Compose configuration:

**File:** [docker/adeline/docker-compose.mqtt.yml](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/docker/adeline/docker-compose.mqtt.yml)

Key configuration aspects:

|Parameter|Value|Purpose|
|---|---|---|
|**Image**|`eclipse-mosquitto:2`|Official Mosquitto Docker image|
|**Container Name**|`mosquitto`|Named container for easy reference|
|**Port Mapping**|`1883:1883`|MQTT protocol (TCP)|
|**Port Mapping**|`9001:9001`|WebSockets (optional)|
|**Volume Mount**|`./mosquitto.conf:/mosquitto/config/mosquitto.conf`|Configuration file|
|**Volume**|`mosquitto_data`|Persistent message storage|
|**Restart Policy**|`unless-stopped`|Automatic restart on failure|

### Mosquitto Configuration File

**File:** [docker/adeline/mosquitto.conf](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/docker/adeline/mosquitto.conf)

The configuration file defines broker behavior:

```
# Authentication (development mode)
allow_anonymous true

# Listeners
listener 1883
listener 9001
protocol websockets

# Persistence
persistence true
persistence_location /mosquitto/data/

# Logging
log_dest stdout
log_type error
log_type warning
log_type notice
log_type information
```

**Configuration Notes:**

- `allow_anonymous true`: Enables unauthenticated connections (development only)
- `listener 1883`: Standard MQTT TCP port
- `listener 9001` + `protocol websockets`: Enables browser-based MQTT clients
- `persistence true`: Messages survive broker restart
- `log_dest stdout`: Logs accessible via `docker logs` or `make services-logs`

**Security Warning:** The default configuration uses `allow_anonymous true` for development. Production deployments should configure authentication via `.env` file (see [MQTT Configuration](https://deepwiki.com/care-foundation/kata-inference-251021-clean2/6.4-mqtt-configuration)).

**Sources:** [docker/adeline/docker-compose.mqtt.yml](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/docker/adeline/docker-compose.mqtt.yml) [docker/adeline/mosquitto.conf](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/docker/adeline/mosquitto.conf) [README.md181-200](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/README.md#L181-L200)

---

## Service Lifecycle Management

### Starting Services

```
# Start all infrastructure services
make services-up

# Explicit module-namespaced command
make adeline.services-up
```

**Implementation:** [Makefile130-135](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/Makefile#L130-L135)

This command:

1. Executes `docker-compose -f docker/adeline/docker-compose.mqtt.yml up -d`
2. Pulls images if not present locally
3. Creates named volumes for persistence
4. Starts containers in detached mode (`-d`)
5. Displays connection information: `MQTT Broker: localhost:1883`

### Stopping Services

```
# Stop all infrastructure services
make services-down
```

**Implementation:** [Makefile136-139](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/Makefile#L136-L139)

This command:

1. Executes `docker-compose down`
2. Stops all running containers
3. Removes containers (but preserves volumes)
4. Network cleanup

**Important:** Volumes persist after `services-down`. To remove volumes (data loss), use `docker-compose down -v`.

### Checking Service Status

```
# Check running services
make services-status
```

**Implementation:** [Makefile144-145](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/Makefile#L144-L145)

Output example:

```
NAME         IMAGE                  COMMAND                  STATUS    PORTS
mosquitto    eclipse-mosquitto:2    "/docker-entrypoint.…"   Up        0.0.0.0:1883->1883/tcp
```

### Viewing Service Logs

```
# Follow logs in real-time
make services-logs
```

**Implementation:** [Makefile141-142](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/Makefile#L141-L142)

This tails logs from all services. Press `Ctrl+C` to exit. Useful for debugging connection issues or broker errors.

**Sources:** [Makefile130-151](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/Makefile#L130-L151) [README.md183-195](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/README.md#L183-L195)

---

## Service Management Workflow

**Diagram: Service Lifecycle Management Sequence**

This sequence shows the typical workflow for managing infrastructure services, from startup through monitoring to graceful shutdown.

**Sources:** [Makefile130-151](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/Makefile#L130-L151) [Makefile74-111](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/Makefile#L74-L111)

---

## go2rtc RTSP Proxy (Optional)

### Purpose

The go2rtc service acts as an RTSP proxy, enabling:

- **Stream transcoding**: Convert between video formats
- **Multi-client support**: Multiple consumers of a single RTSP stream
- **Protocol bridging**: RTSP → WebRTC, HLS, etc.
- **Stream reliability**: Buffer and retry logic

### Configuration

**File:** [config/adeline/go2rtc.yaml](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/config/adeline/go2rtc.yaml)

Example configuration structure:

```
streams:
  camera1:
    - rtsp://username:password@camera-ip:554/stream
  camera2:
    - rtsp://192.168.1.100:554/live
```

### Integration with Adeline

The `config.yaml` references RTSP URLs that may point to go2rtc endpoints:

```
pipeline:
  rtsp_url: "rtsp://localhost:8554/camera1"  # go2rtc proxy URL
```

### Running go2rtc

**Note:** go2rtc is not managed by the Adeline Docker Compose file. It must be run separately.

Common approaches:

1. **Standalone binary**: Download from go2rtc releases
2. **Docker container**:
    
    ```
    docker run -p 8554:8554 -v $(pwd)/config/adeline/go2rtc.yaml:/config/go2rtc.yaml alexxit/go2rtc
    ```
    
3. **Home Assistant add-on**: If using Home Assistant

**Sources:** [README.md5-52](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/README.md#L5-L52) [config/adeline/go2rtc.yaml](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/config/adeline/go2rtc.yaml)

---

## Connection Configuration

### Python Client Connection

Both the control and data planes connect to the MQTT broker using configuration from `.env`:

**Environment Variables:**

```
MQTT_BROKER_HOST=localhost
MQTT_BROKER_PORT=1883
MQTT_USERNAME=           # Optional
MQTT_PASSWORD=           # Optional
```

### Client Identifiers

**Diagram: MQTT Client Connections and Identifiers**

Each Python component uses a unique `client_id` to connect to the broker. The broker maintains separate sessions for each client, enabling multiplexed communication.

**Sources:** [adeline/control/plane.py](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py) [adeline/data/plane.py](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/data/plane.py) [adeline/data/monitors/](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/data/monitors/)

---

## Service Dependencies

### Startup Order

The correct startup sequence is:

1. **Infrastructure services** (MQTT broker)
2. **Optional services** (go2rtc if using RTSP proxy)
3. **Adeline pipeline** (connects to services)

```
# Recommended startup sequence
make services-up          # Start MQTT broker
# (Start go2rtc separately if needed)
make run                  # Start inference pipeline
```

### Dependency Check

Before starting the pipeline, verify services are running:

```
# Check service status
make services-status

# Test MQTT connectivity (requires mosquitto-clients)
mosquitto_pub -h localhost -p 1883 -t test/topic -m "test"
```

If `mosquitto_pub` is not available, the monitoring tools can verify connectivity:

```
make monitor-status    # Should connect without errors
```

**Sources:** [Makefile130-151](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/Makefile#L130-L151) [README.md54-103](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/README.md#L54-L103)

---

## Troubleshooting

### Common Issues

|Problem|Symptom|Solution|
|---|---|---|
|**Port already in use**|`Error: Port 1883 already allocated`|Another service using port 1883. Stop conflicting service or change port mapping|
|**Connection refused**|`ConnectionRefusedError` in Python|Broker not running. Run `make services-up`|
|**Authentication failed**|`Connection Refused, not authorized`|Check `.env` credentials match `mosquitto.conf` configuration|
|**Container not starting**|`make services-status` shows no containers|Check Docker daemon running: `docker ps`|
|**Volume permission errors**|Mosquitto fails to write persistence|Check volume mount permissions in Docker|

### Diagnostic Commands

```
# Check if Docker is running
docker ps

# Check if Mosquitto container exists
docker ps -a | grep mosquitto

# View Mosquitto logs
make services-logs

# Test MQTT connection from command line
mosquitto_sub -h localhost -p 1883 -t '#' -v

# Check port availability
netstat -an | grep 1883
lsof -i :1883
```

### Restart Services

If services are misbehaving:

```
# Full restart
make services-down
make services-up

# Force recreate containers
docker-compose -f docker/adeline/docker-compose.mqtt.yml up -d --force-recreate
```

### Clean State

To completely reset services (removes data):

```
# Stop and remove everything including volumes
docker-compose -f docker/adeline/docker-compose.mqtt.yml down -v

# Restart fresh
make services-up
```

**Warning:** Using `-v` flag removes persistent data. Message history and retained messages will be lost.

**Sources:** [Makefile130-151](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/Makefile#L130-L151) [docker/adeline/docker-compose.mqtt.yml](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/docker/adeline/docker-compose.mqtt.yml)

---

## Production Considerations

### Security Hardening

For production deployments, update [docker/adeline/mosquitto.conf](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/docker/adeline/mosquitto.conf):

1. **Disable anonymous access:**
    
    ```
    allow_anonymous false
    password_file /mosquitto/config/passwd
    ```
    
2. **Generate password file:**
    
    ```
    docker exec mosquitto mosquitto_passwd -c /mosquitto/config/passwd username
    ```
    
3. **Update `.env` with credentials:**
    
    ```
    MQTT_USERNAME=username
    MQTT_PASSWORD=secure_password
    ```
    
4. **Restart broker:**
    
    ```
    make services-down
    make services-up
    ```
    

### TLS/SSL Configuration

For encrypted connections, add to `mosquitto.conf`:

```
listener 8883
cafile /mosquitto/config/ca.crt
certfile /mosquitto/config/server.crt
keyfile /mosquitto/config/server.key
```

Update `.env`:

```
MQTT_BROKER_PORT=8883
MQTT_USE_TLS=true
```

### Resource Limits

Add to [docker/adeline/docker-compose.mqtt.yml](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/docker/adeline/docker-compose.mqtt.yml):

```
services:
  mosquitto:
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          memory: 128M
```

### Monitoring and Alerting

Production deployments should monitor:

- Broker uptime and restarts
- Connection counts
- Message throughput
- Memory usage
- Disk space (persistence volume)

Integration with monitoring systems:

- Prometheus exporter: `mosquitto-exporter`
- Health check endpoint: Add to Docker Compose
- Log aggregation: Forward logs to centralized logging

**Sources:** [docker/adeline/docker-compose.mqtt.yml](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/docker/adeline/docker-compose.mqtt.yml) [docker/adeline/mosquitto.conf](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/docker/adeline/mosquitto.conf)

---

## Quick Reference

### Essential Commands

|Command|Purpose|
|---|---|
|`make services-up`|Start all infrastructure services|
|`make services-down`|Stop all infrastructure services|
|`make services-status`|Check service health|
|`make services-logs`|View service logs|
|`make dev`|Setup complete dev environment (services + install)|

### Service Endpoints

|Service|Endpoint|Protocol|
|---|---|---|
|MQTT Broker|`localhost:1883`|MQTT (TCP)|
|MQTT WebSocket|`localhost:9001`|MQTT over WebSocket|
|go2rtc (optional)|User-configured|RTSP|

### Configuration Files

|File|Purpose|Git Tracked|
|---|---|---|
|[docker/adeline/docker-compose.mqtt.yml](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/docker/adeline/docker-compose.mqtt.yml)|Service definitions|Yes|
|[docker/adeline/mosquitto.conf](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/docker/adeline/mosquitto.conf)|Broker configuration|Yes|
|[config/adeline/go2rtc.yaml](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/config/adeline/go2rtc.yaml)|RTSP proxy config|Yes|
|`.env`|Credentials|No (example: `.env.example`)|

**Sources:** [Makefile130-151](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/Makefile#L130-L151) [README.md172-180](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/README.md#L172-L180) [adeline/CLAUDE.md132-137](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L132-L137)