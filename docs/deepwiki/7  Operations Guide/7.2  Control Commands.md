# Control Commands

Relevant source files

- [adeline/CLAUDE.md](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md)
- [adeline/control/cli.py](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/cli.py)
- [adeline/control/plane.py](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py)

## Purpose and Scope

This page documents all control commands available in the Adeline inference system, explaining how to send commands to the pipeline via MQTT, their expected behavior, and response patterns. Control commands enable remote management of the pipeline lifecycle, configuration adjustments, and diagnostic operations.

For information about monitoring command responses and data output, see [Monitoring and Data Streams](https://deepwiki.com/care-foundation/kata-inference-251021-clean2/7.3-monitoring-and-data-streams). For configuration of MQTT connection settings, see [MQTT Configuration](https://deepwiki.com/care-foundation/kata-inference-251021-clean2/6.4-mqtt-configuration). For overall system operations, see [Operations Guide](https://deepwiki.com/care-foundation/kata-inference-251021-clean2/7-operations-guide).

---

## Command Overview

The Adeline system exposes **seven control commands** for managing the inference pipeline remotely via MQTT. All commands use **QoS 1** (at-least-once delivery) to ensure reliable command processing, even in unreliable network conditions.

**Available Commands:**

|Command|Purpose|Callback Trigger|
|---|---|---|
|`pause`|Suspends inference processing|`MQTTControlPlane.on_pause()`|
|`resume`|Resumes inference after pause|`MQTTControlPlane.on_resume()`|
|`stop`|Terminates pipeline completely|`MQTTControlPlane.on_stop()`|
|`status`|Queries current pipeline state|None (publishes current status)|
|`metrics`|Triggers watchdog metrics publication|`MQTTControlPlane.on_metrics()`|
|`toggle_crop`|Enables/disables ROI cropping|`MQTTControlPlane.on_toggle_crop()`|
|`stabilization_stats`|Publishes detection stabilization statistics|`MQTTControlPlane.on_stabilization_stats()`|

**Sources:** [adeline/control/plane.py19-57](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L19-L57) [adeline/CLAUDE.md27-30](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L27-L30)

---

## Control Plane Architecture

The following diagram shows how control commands flow from external clients through the MQTT broker to the control plane, and how the control plane interacts with the pipeline controller.

**Sources:** [adeline/control/plane.py19-213](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L19-L213) [adeline/control/cli.py1-88](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/cli.py#L1-L88)

---

## Command Reference

### pause

Suspends inference processing without terminating the pipeline. The pipeline remains connected to the video source and MQTT broker but stops processing frames.

**Behavior:**

- Invokes `MQTTControlPlane.on_pause()` callback
- Pipeline transitions to "paused" state
- Status message published: `{"status": "paused", "timestamp": "...", "client_id": "inference_control"}`
- Video stream connection maintained
- MQTT connections remain active

**Use Cases:**

- Temporarily halt processing during known periods of no activity
- Reduce CPU/GPU usage without full shutdown
- Debugging or manual inspection

**Sources:** [adeline/control/plane.py98-108](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L98-L108)

---

### resume

Resumes inference processing after a `pause` command. Restores the pipeline to its normal operating state.

**Behavior:**

- Invokes `MQTTControlPlane.on_resume()` callback
- Pipeline transitions to "running" state
- Status message published: `{"status": "running", ...}`
- Frame processing resumes immediately
- Detection results published to data plane

**Use Cases:**

- Restart processing after scheduled pause
- Resume after manual inspection period
- Return to normal operations after temporary halt

**Sources:** [adeline/control/plane.py110-120](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L110-L120)

---

### stop

Terminates the inference pipeline completely. This is a graceful shutdown that closes all connections and releases resources.

**Behavior:**

- Invokes `MQTTControlPlane.on_stop()` callback
- Pipeline initiates shutdown sequence
- Status message published: `{"status": "stopped", ...}`
- Video stream connection closed
- MQTT connections gracefully disconnected
- Process exits after cleanup

**Use Cases:**

- Graceful shutdown from remote location
- Automated deployment updates
- Emergency termination via control command

**Important:** After `stop`, the pipeline process terminates. To restart, re-run `python -m adeline` or `make run`.

**Sources:** [adeline/control/plane.py122-132](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L122-L132)

---

### status

Queries the current pipeline state without changing it. This is a read-only operation.

**Behavior:**

- No callback invoked
- Immediately publishes current status
- Status reflects actual pipeline state: "running", "paused", "stopped", or "connected"
- Uses retained message (QoS 1) so late joiners receive last known state

**Response Format:**

```
{
  "status": "running",
  "timestamp": "2024-01-15T10:30:45.123456",
  "client_id": "inference_control"
}
```

**Use Cases:**

- Health checks from monitoring systems
- Verify pipeline state before sending other commands
- Dashboard status updates

**Sources:** [adeline/control/plane.py134-136](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L134-L136) [adeline/control/plane.py181-194](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L181-L194)

---

### metrics

Triggers publication of pipeline watchdog metrics via MQTT. Provides performance diagnostics including FPS, processing latency, and resource utilization.

**Behavior:**

- Invokes `MQTTControlPlane.on_metrics()` callback
- Metrics published to data plane topic (not control plane)
- Metrics include: FPS, frame processing time, detection counts
- Published via `MQTTDataPlane` (QoS 0) for performance

**Metrics Published:**

- Frames per second (FPS)
- Average inference latency
- Detection statistics
- ROI processing overhead (if enabled)
- Stabilization buffer state (if enabled)

**Use Cases:**

- Performance monitoring and tuning
- Identifying bottlenecks
- Capacity planning

**Sources:** [adeline/control/plane.py138-147](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L138-L147) [adeline/CLAUDE.md28-29](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L28-L29)

---

### toggle_crop

Enables or disables ROI (Region of Interest) cropping dynamically. This command only functions when ROI strategy is enabled in configuration.

**Behavior:**

- Invokes `MQTTControlPlane.on_toggle_crop()` callback
- Toggles between full-frame and ROI-cropped processing
- State persists until next toggle or pipeline restart
- No effect if ROI strategy mode is `"none"`

**Prerequisites:**

- `roi_strategy.mode` must be `"adaptive"` or `"fixed"` in configuration
- If mode is `"none"`, command logs warning and has no effect

**Use Cases:**

- Compare full-frame vs. ROI-cropped detection performance
- Debug ROI calculation issues
- Temporarily disable crop without configuration change

**Sources:** [adeline/control/plane.py149-158](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L149-L158) [adeline/CLAUDE.md62](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L62-L62)

---

### stabilization_stats

Publishes detection stabilization statistics, including buffer states, hysteresis thresholds, and detection persistence metrics.

**Behavior:**

- Invokes `MQTTControlPlane.on_stabilization_stats()` callback
- Statistics published to control status topic
- Includes buffer size, confirmed detections, pending detections
- Only available when stabilization mode is not `"none"`

**Statistics Included:**

- Detection buffer depth
- High/low threshold values
- Number of confirmed vs. pending detections
- Temporal smoothing parameters

**Prerequisites:**

- `detection_stabilization.mode` must be `"temporal"` or other non-`"none"` mode
- If mode is `"none"`, command logs warning and has no effect

**Use Cases:**

- Debug flickering detection issues
- Tune stabilization parameters
- Verify temporal filtering behavior

**Sources:** [adeline/control/plane.py160-169](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L160-L169) [adeline/CLAUDE.md69](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L69-L69)

---

## Message Format

All control commands follow a standardized JSON message format for consistency and ease of parsing.

### Command Message Structure

Commands are published to `inference/control/commands` with the following JSON payload:

```
{
  "command": "pause"
}
```

**Command Field Values:**

- `"pause"` - Suspend processing
- `"resume"` - Resume processing
- `"stop"` - Terminate pipeline
- `"status"` - Query state
- `"metrics"` - Publish diagnostics
- `"toggle_crop"` - Toggle ROI
- `"stabilization_stats"` - Query stabilization

**Sources:** [adeline/control/plane.py87-179](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L87-L179) [adeline/CLAUDE.md128-130](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L128-L130)

### Status Message Structure

Status responses are published to `inference/control/status` with this structure:

```
{
  "status": "running",
  "timestamp": "2024-01-15T10:30:45.123456",
  "client_id": "inference_control"
}
```

**Status Field Values:**

- `"connected"` - Control plane connected to broker
- `"running"` - Pipeline actively processing frames
- `"paused"` - Pipeline suspended
- `"stopped"` - Pipeline terminated
- `"disconnected"` - Control plane disconnected

**Message Properties:**

- QoS: 1 (reliable delivery)
- Retained: Yes (last status persists)
- Timestamp: ISO 8601 format

**Sources:** [adeline/control/plane.py181-194](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L181-L194)

---

## Using the Control CLI

The system provides a command-line interface for sending control commands via the `adeline.control.cli` module.

### CLI Command Syntax

**Sources:** [adeline/control/cli.py21-86](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/cli.py#L21-L86)

### CLI Command Examples

**Basic Commands:**

```
# Pause pipeline
python -m adeline.control.cli pause

# Resume pipeline
python -m adeline.control.cli resume

# Stop pipeline
python -m adeline.control.cli stop

# Query status
python -m adeline.control.cli status

# Toggle ROI cropping
python -m adeline.control.cli toggle_crop
```

**With Custom Broker:**

```
# Connect to remote broker
python -m adeline.control.cli --broker 192.168.1.100 --port 1883 pause

# Custom topic
python -m adeline.control.cli --topic custom/control/commands stop
```

**Makefile Shortcuts:**

```
# Convenience wrappers
make pause
make resume
make stop
make status
```

**Sources:** [adeline/control/cli.py53-86](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/cli.py#L53-L86) [adeline/CLAUDE.md11-13](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L11-L13)

### CLI Implementation Details

The CLI implementation in `send_command()` follows this sequence:

1. Create `paho.mqtt.client.Client` with ID `"mqtt_control_cli"`
2. Connect to broker (60s keepalive)
3. Publish JSON command to topic with QoS 1
4. Wait for publish confirmation
5. Disconnect immediately (fire-and-forget client)

**Return Codes:**

- `0` - Command sent successfully
- `1` - Connection or publish error

**Sources:** [adeline/control/cli.py21-51](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/cli.py#L21-L51)

---

## Direct MQTT Integration

For custom integrations, commands can be sent directly using any MQTT client library.

### Python Example (paho-mqtt)

```
import json
import paho.mqtt.client as mqtt

# Create client
client = mqtt.Client(client_id="my_controller", protocol=mqtt.MQTTv5)

# Connect
client.connect("localhost", 1883, keepalive=60)

# Send pause command
command = {"command": "pause"}
client.publish(
    "inference/control/commands",
    json.dumps(command),
    qos=1
)

client.disconnect()
```

### Connection Requirements

|Parameter|Value|Notes|
|---|---|---|
|Protocol|MQTTv5|MQTTv311 also supported|
|Client ID|Unique string|Prevents connection conflicts|
|Keepalive|60 seconds|Standard value|
|QoS|1|Ensures delivery|
|Broker Host|`localhost` or configured|See [MQTT Configuration](https://deepwiki.com/care-foundation/kata-inference-251021-clean2/6.4-mqtt-configuration)|
|Broker Port|`1883`|Standard MQTT port|

**Sources:** [adeline/control/cli.py24-50](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/cli.py#L24-L50) [adeline/control/plane.py35-66](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L35-L66)

---

## Command Response Patterns

### Synchronous Response (status)

The `status` command provides immediate synchronous feedback:

**Sources:** [adeline/control/plane.py134-136](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L134-L136) [adeline/control/plane.py181-194](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L181-L194)

### Asynchronous Callbacks (pause/resume/stop)

State-changing commands trigger asynchronous callbacks that execute pipeline operations:

**Sources:** [adeline/control/plane.py87-179](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L87-L179)

---

## Callback Registration

The `MQTTControlPlane` class exposes callback hooks that the `InferencePipelineController` binds to pipeline operations during initialization.

### Callback Attributes

```
class MQTTControlPlane:
    # Lifecycle control
    on_stop: Optional[Callable[[], None]] = None
    on_pause: Optional[Callable[[], None]] = None
    on_resume: Optional[Callable[[], None]] = None
    
    # Diagnostic commands
    on_metrics: Optional[Callable[[], None]] = None
    
    # Feature toggles
    on_toggle_crop: Optional[Callable[[], None]] = None
    on_stabilization_stats: Optional[Callable[[], None]] = None
```

**Registration Pattern:**

The controller binds lambda functions or methods to these callbacks:

```
control_plane.on_pause = lambda: pipeline.pause()
control_plane.on_resume = lambda: pipeline.resume()
control_plane.on_stop = lambda: self.terminate()
```

**Callback Behavior:**

- Callbacks are optional (can be `None`)
- If `None`, command logs warning and has no effect
- Exceptions in callbacks are caught and logged
- Callbacks execute in MQTT client thread

**Sources:** [adeline/control/plane.py51-57](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L51-L57) [adeline/control/plane.py100-169](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L100-L169)

---

## Error Handling

### Command Processing Errors

The control plane implements defensive error handling:

|Error Type|Behavior|Example|
|---|---|---|
|JSON decode failure|Log error, skip command|Invalid JSON payload|
|Unknown command|Log warning, no action|`{"command": "invalid"}`|
|Callback exception|Log error with traceback, continue|Exception in `on_pause()`|
|Missing callback|Log warning, no action|`toggle_crop` when ROI disabled|

**Error Logging:**

```
# adeline/control/plane.py:176-179
except json.JSONDecodeError:
    logger.error(f"❌ Error decodificando JSON: {msg.payload}")
except Exception as e:
    logger.error(f"❌ Error procesando mensaje: {e}")
```

**Sources:** [adeline/control/plane.py176-179](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L176-L179) [adeline/control/plane.py100-169](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L100-L169)

### Connection Failures

The CLI handles connection errors gracefully:

```
# adeline/control/cli.py:29-33
try:
    client.connect(broker, port, keepalive=60)
except Exception as e:
    print(f"❌ Error conectando: {e}")
    return False
```

**CLI Exit Codes:**

- `0` - Success
- `1` - Connection or publish failure

**Sources:** [adeline/control/cli.py28-50](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/cli.py#L28-L50)

---

## QoS Strategy Rationale

Control commands use **QoS 1** (at-least-once delivery) to ensure critical operations are not lost.

### QoS Level Comparison

|QoS Level|Guarantee|Use Case|
|---|---|---|
|**0**|Best effort, no acknowledgment|Data plane (high-volume detections)|
|**1**|At-least-once delivery|**Control plane (commands, status)**|
|2|Exactly-once delivery|Not used (overhead too high)|

### Control Plane (QoS 1)

**Rationale:**

- `stop` command must not be lost (prevents orphaned processes)
- `pause`/`resume` ensure deterministic state transitions
- Status updates provide reliable health monitoring
- Network hiccups should not drop critical commands

**Implementation:**

```
# adeline/control/cli.py:40
result = client.publish(topic, payload, qos=1)

# adeline/control/plane.py:75
self.client.subscribe(self.command_topic, qos=1)
```

**Sources:** [adeline/control/cli.py40](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/cli.py#L40-L40) [adeline/control/plane.py75](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L75-L75) [adeline/CLAUDE.md102-104](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L102-L104)

---

## Integration with Pipeline Controller

The `InferencePipelineController` orchestrates control plane callbacks and pipeline operations. This diagram shows the complete integration:

**Initialization Sequence:**

1. Controller creates `MQTTControlPlane` instance
2. Controller binds callbacks to pipeline operations
3. Controller calls `control_plane.connect()`
4. Control plane subscribes to command topic
5. Pipeline runs until `SIGINT`/`SIGTERM` or `stop` command
6. Shutdown triggers `control_plane.disconnect()`

**Sources:** [adeline/control/plane.py19-213](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L19-L213) [adeline/CLAUDE.md39-42](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L39-L42)

---

## Command Limitations and Constraints

### Feature-Specific Commands

Some commands require specific configuration to function:

|Command|Requirement|Failure Behavior|
|---|---|---|
|`toggle_crop`|`roi_strategy.mode != "none"`|Logs warning, no effect|
|`stabilization_stats`|`detection_stabilization.mode != "none"`|Logs warning, no effect|
|`metrics`|Data plane initialized|Callback required|

**Sources:** [adeline/control/plane.py149-169](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L149-L169)

### No START Command

The pipeline auto-starts when `python -m adeline` executes. There is no `start` command because:

1. Pipeline initialization requires configuration loading
2. Video stream connection happens at startup
3. Model loading occurs during import (cannot defer)
4. Control plane connects after pipeline initialization

To restart after `stop`, re-run the main application entry point.

**Sources:** [adeline/control/cli.py13](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/cli.py#L13-L13) [adeline/control/plane.py32](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L32-L32)

### Thread Safety

Control plane callbacks execute in the MQTT client's network thread, not the main application thread. Controllers must ensure:

- Pipeline operations are thread-safe
- State transitions use appropriate synchronization
- Callbacks complete quickly to avoid blocking MQTT processing

**Sources:** [adeline/control/plane.py87-180](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L87-L180)