# MQTT Configuration

Relevant source files

- [README.md](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/README.md)
- [adeline/config.py](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/config.py)
- [adeline/control/plane.py](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py)

This page documents MQTT broker settings, credentials, topics, QoS configurations, and connection parameters for the Adeline inference system. MQTT serves as the communication backbone for both the Control Plane (command handling) and Data Plane (detection output).

For information about the MQTT communication architecture and control/data plane separation, see [MQTT Communication Architecture](https://deepwiki.com/care-foundation/kata-inference-251021-clean2/3.2-mqtt-communication-architecture). For operational usage of MQTT control commands, see [Control Commands](https://deepwiki.com/care-foundation/kata-inference-251021-clean2/7.2-control-commands).

---

## Configuration Hierarchy

MQTT configuration follows a three-tier hierarchy that separates sensitive credentials from operational settings:

**Configuration Loading Priority:**

1. **Environment variables** (`.env`) - Highest priority for credentials
2. **YAML config file** (`config/adeline/config.yaml`) - Operational settings with defaults
3. **Hardcoded defaults** - Fallback values in code

**Sources:** [adeline/config.py102-123](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/config.py#L102-L123) [README.md173-180](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/README.md#L173-L180)

---

## Broker Configuration

The MQTT broker settings control the connection endpoint and authentication:

### Configuration Schema

|Configuration Key|Source|Type|Default|Description|
|---|---|---|---|---|
|`mqtt.broker.host`|config.yaml|string|`localhost`|MQTT broker hostname or IP|
|`mqtt.broker.port`|config.yaml|integer|`1883`|MQTT broker port|
|`mqtt.broker.username`|config.yaml / `.env`|string|`None`|MQTT username (optional)|
|`mqtt.broker.password`|`.env`|string|`None`|MQTT password (optional)|

### Implementation

**Credential Priority Logic:**

- Username: `os.getenv('MQTT_USERNAME')` takes precedence over `broker.username` in config.yaml
- Password: `os.getenv('MQTT_PASSWORD')` takes precedence over `broker.password` in config.yaml

This allows development with config.yaml defaults while production deploys can override via environment variables without modifying configuration files.

**Sources:** [adeline/config.py102-111](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/config.py#L102-L111)

---

## Topic Structure

MQTT topics are organized to separate control operations from data streams:

### Topic Hierarchy

### Topic Configuration

|Configuration Key|Type|Default|Purpose|
|---|---|---|---|
|`mqtt.topics.control_commands`|string|`inference/control/commands`|Inbound control commands|
|`mqtt.topics.control_status`|string|`inference/control/status`|Outbound status updates|
|`mqtt.topics.data`|string|`inference/data/detections`|Detection results stream|
|`mqtt.topics.metrics`|string|`inference/data/metrics`|Performance metrics|

### Configuration Loading

**Topic Usage in Code:**

- **Control Plane** subscribes to `control_commands` [adeline/control/plane.py75](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L75-L75)
- **Control Plane** publishes to `control_status` [adeline/control/plane.py188-193](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L188-L193)
- **Data Plane** publishes to `data` and `metrics` topics

**Sources:** [adeline/config.py112-117](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/config.py#L112-L117) [adeline/control/plane.py39-48](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L39-L48)

---

## QoS Strategy

Quality of Service (QoS) levels are strategically chosen to optimize for reliability (control) vs throughput (data):

### QoS Configuration

|Configuration Key|Type|Default|Applied To|Rationale|
|---|---|---|---|---|
|`mqtt.qos.control`|integer|`1`|Control Plane|At-least-once delivery for commands|
|`mqtt.qos.data`|integer|`0`|Data Plane|Best-effort for high-volume streams|

### QoS Level Comparison

### Implementation Details

**Control Plane QoS 1 Enforcement:**

```
MQTTControlPlane.client.subscribe(command_topic, qos=1)  # Line 75
MQTTControlPlane._publish_status(..., qos=1, retain=True)  # Line 188-193
```

**Why QoS 1 for Control:**

- Commands like `stop` must not be lost
- Status updates should reflect the latest state (retained messages)
- Network interruptions should not cause missed commands
- Overhead is acceptable for low-volume traffic

**Why QoS 0 for Data:**

- Detection streams can produce 30+ messages/second
- Missing one frame detection is acceptable (video is continuous)
- ACK overhead would limit throughput
- Latency is more important than guaranteed delivery

**Sources:** [adeline/config.py119-122](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/config.py#L119-L122) [adeline/control/plane.py75](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L75-L75) [adeline/control/plane.py188-193](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L188-L193)

---

## Connection Parameters

MQTT client connection behavior is controlled by several parameters:

### Client Configuration

### Connection Parameter Reference

|Parameter|Code Location|Default|Description|
|---|---|---|---|
|`broker_host`|[control/plane.py37](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/control/plane.py#L37-L37)|From config|MQTT broker hostname|
|`broker_port`|[control/plane.py38](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/control/plane.py#L38-L38)|`1883`|MQTT broker port|
|`client_id`|[control/plane.py41](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/control/plane.py#L41-L41)|`inference_control`|Unique client identifier|
|`keepalive`|[control/plane.py200](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/control/plane.py#L200-L200)|`60` seconds|Connection keepalive interval|
|`protocol`|[control/plane.py60](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/control/plane.py#L60-L60)|`MQTTv5`|MQTT protocol version|
|`timeout`|[control/plane.py196](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/control/plane.py#L196-L196)|`5.0` seconds|Connection timeout|

### Connection Flow

**Connection Establishment Steps:**

1. Create MQTT client with MQTTv5 protocol [control/plane.py60](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/control/plane.py#L60-L60)
2. Set authentication credentials if provided [control/plane.py61-62](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/control/plane.py#L61-L62)
3. Register callbacks for connect/message/disconnect [control/plane.py64-66](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/control/plane.py#L64-L66)
4. Connect to broker with 60-second keepalive [control/plane.py200](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/control/plane.py#L200-L200)
5. Start network loop in background thread [control/plane.py201](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/control/plane.py#L201-L201)
6. Wait for connection confirmation (5 second timeout) [control/plane.py202](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/control/plane.py#L202-L202)
7. On connect, subscribe to command topic with QoS 1 [control/plane.py75](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/control/plane.py#L75-L75)
8. Publish initial `connected` status [control/plane.py78](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/control/plane.py#L78-L78)

**Sources:** [adeline/control/plane.py35-66](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L35-L66) [adeline/control/plane.py196-202](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L196-L202) [adeline/control/plane.py71-80](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L71-L80)

---

## Credential Management

Credentials are managed separately from configuration to support secure deployment:

### Credential Flow

### Credential Priority

**Priority Order (highest to lowest):**

1. **Environment variable** `MQTT_USERNAME` / `MQTT_PASSWORD`
2. **Config file** `mqtt.broker.username` / `mqtt.broker.password`
3. **None** (no authentication)

### Security Best Practices

**Development:**

```
# .env file (gitignored)
MQTT_USERNAME=dev_user
MQTT_PASSWORD=dev_password
```

**Production:**

```
# Set via deployment system
export MQTT_USERNAME=prod_user
export MQTT_PASSWORD=$(cat /run/secrets/mqtt_password)
```

**Configuration File (should NOT contain production credentials):**

```
# config/adeline/config.yaml
mqtt:
  broker:
    host: localhost
    port: 1883
    username: null  # Override with environment variable
    password: null  # Override with environment variable
```

### Authentication in Client

**Authentication Logic:**

- If both username and password are provided, authentication is enabled [control/plane.py61-62](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/control/plane.py#L61-L62)
- If either is `None`, client connects anonymously
- Broker must be configured to allow the chosen authentication mode

**Sources:** [adeline/config.py14](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/config.py#L14-L14) [adeline/config.py109-110](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/config.py#L109-L110) [adeline/control/plane.py61-62](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L61-L62)

---

## Configuration Example

Complete MQTT configuration demonstrating all options:

### config.yaml

```
mqtt:
  broker:
    host: localhost
    port: 1883
    username: null  # Use environment variable
    password: null  # Use environment variable
  
  topics:
    control_commands: inference/control/commands
    control_status: inference/control/status
    data: inference/data/detections
    metrics: inference/data/metrics
  
  qos:
    control: 1  # At-least-once delivery
    data: 0     # Best-effort delivery
```

### .env

```
# MQTT Credentials
MQTT_USERNAME=inference_user
MQTT_PASSWORD=secure_password_here

# API Key (for Roboflow models, not MQTT)
ROBOFLOW_API_KEY=your_api_key_here
```

### Docker Compose Infrastructure

```
# docker/adeline/docker-compose.mqtt.yml
services:
  mosquitto:
    image: eclipse-mosquitto:2
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf
```

**Sources:** [adeline/config.py102-123](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/config.py#L102-L123) [README.md196-199](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/README.md#L196-L199)

---

## Configuration Validation

The system performs validation during initialization:

### Validation Flow

**Validation Checks:**

1. **Config file existence** - Raises `FileNotFoundError` if missing [config.py68-72](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/config.py#L68-L72)
2. **Default values** - Applies sensible defaults for all MQTT settings
3. **Environment variables** - Validates and loads credentials
4. **No runtime validation** - Configuration errors discovered at connection time

**Error Messages:**

```
Config file not found: config/adeline/config.yaml
Please create it from config/adeline/config.yaml.example
```

**Sources:** [adeline/config.py59-122](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/config.py#L59-L122)

---

## Connection Diagnostics

### Connection Success Logging

```
✅ Control Plane conectado a localhost:1883
📡 Suscrito a: inference/control/commands
📤 Status publicado: connected
```

### Connection Failure Scenarios

|Scenario|Log Message|Cause|Resolution|
|---|---|---|---|
|Broker unreachable|`❌ Error conectando al broker MQTT: [errno]`|Network/firewall|Check broker is running: `make services-status`|
|Authentication failed|`❌ Error conectando al broker MQTT: 5`|Invalid credentials|Verify `MQTT_USERNAME` and `MQTT_PASSWORD`|
|Connection lost|`⚠️ Control Plane desconectado (rc=[code])`|Network interruption|Client auto-reconnects|
|Subscription failed|No subscription confirmation|Permission denied|Check broker ACLs|

### Troubleshooting Commands

```
# Check broker is running
docker ps | grep mosquitto

# Check broker logs
docker logs mqtt-mosquitto

# Test connection manually
mosquitto_sub -h localhost -p 1883 -t 'inference/#' -v

# Publish test command
mosquitto_pub -h localhost -p 1883 -t 'inference/control/commands' \
  -m '{"command":"status"}'
```

**Sources:** [adeline/control/plane.py71-85](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L71-L85) [adeline/control/plane.py196-205](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L196-L205)