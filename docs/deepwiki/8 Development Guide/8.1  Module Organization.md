# Module Organization

Relevant source files

- [README.md](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/README.md)
- [adeline/__init__.py](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/__init__.py)
- [adeline/control/__init__.py](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/__init__.py)

## Purpose and Scope

This document explains the internal package structure of the Adeline inference system and the responsibilities of each module. It serves as a map for developers navigating the codebase, showing where different functionality lives and how modules interact.

For information about specific entry points (`python -m adeline`, `python -m adeline.control`, etc.), see [Entry Points](https://deepwiki.com/care-foundation/kata-inference-251021-clean2/8.2-entry-points). For detailed implementation of individual components, see sections [5.1](https://deepwiki.com/care-foundation/kata-inference-251021-clean2/5.1-pipeline-controller) through [5.6](https://deepwiki.com/care-foundation/kata-inference-251021-clean2/5.6-detection-stabilization).

## Top-Level Structure

The Adeline system follows a **modular, multi-package architecture** where configuration, documentation, and infrastructure are separated from Python code:

```
251021/                        # Project root
├── adeline/                   # Python package (application code)
├── config/adeline/            # Configuration files
├── docker/adeline/            # Infrastructure definitions
├── docs/adeline/              # Documentation
├── scripts/adeline/           # Utility scripts
├── .env                       # Environment variables (secrets)
├── Makefile                   # Automation commands
└── pyproject.toml             # Python dependencies
```

**Design Rationale**: This separation allows configuration and infrastructure to be versioned independently from code, supports multiple modules in the same repository (e.g., future `cupertino/` module), and follows best practices for separating concerns.

**Sources**: [README.md5-52](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/README.md#L5-L52)

## The `adeline` Package

The `adeline/` directory is a Python package with the following internal organization:

**Sources**: [README.md36-44](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/README.md#L36-L44) [adeline/__init__.py1-44](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/__init__.py#L1-L44)

## Module Responsibilities

|Module|Primary Responsibility|Key Classes/Functions|Layer|
|---|---|---|---|
|**Root Package**|Public API surface, entry points|`PipelineConfig`, `disable_models_from_config`, `__main__.py`|API|
|**app/**|Application orchestration, lifecycle management|`InferencePipelineController`, `main()`|Application|
|**control/**|MQTT control plane (QoS 1), command handling|`MQTTControlPlane`, CLI commands|Control Plane|
|**data/**|MQTT data plane (QoS 0), publishing, monitoring|`MQTTDataPlane`, `create_mqtt_sink()`|Data Plane|
|**inference/**|ML logic, model management, processing strategies|Model loaders, ROI strategies, stabilization|Business Logic|
|**visualization/**|OpenCV display, annotated frame output|`create_visualization_sink()`|Presentation|

**Sources**: [README.md36-44](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/README.md#L36-L44)

## Root Package (`adeline/`)

### `__init__.py` - Public API Surface

The root `__init__.py` defines what external code can import from the package:

```
from .config import PipelineConfig, disable_models_from_config
from .app import InferencePipelineController, main
from .control import MQTTControlPlane
from .data import MQTTDataPlane, create_mqtt_sink

__all__ = [
    "PipelineConfig",
    "disable_models_from_config",
    "InferencePipelineController",
    "main",
    "MQTTControlPlane",
    "MQTTDataPlane",
    "create_mqtt_sink",
]
```

**Design Decision**: Only 7 symbols are exported, enforcing a **minimal public API**. Internal implementation details (ROI strategies, stabilization logic, etc.) are not directly exposed, encouraging usage through the configured `InferencePipelineController`.

**Sources**: [adeline/__init__.py27-44](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/__init__.py#L27-L44)

### `__main__.py` - Primary Entry Point

This file enables `python -m adeline` to start the main inference pipeline:

```
# When run as: python -m adeline
if __name__ == "__main__":
    from .app import main
    main()
```

The `main()` function lives in `app/controller.py` and handles the full lifecycle: configuration loading, controller initialization, signal handling, and graceful shutdown.

**Sources**: [adeline/__init__.py14-15](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/__init__.py#L14-L15)

### `config.py` - Configuration System

Contains `PipelineConfig` class and the critical `disable_models_from_config()` function. See [Configuration Hierarchy](https://deepwiki.com/care-foundation/kata-inference-251021-clean2/6.1-configuration-hierarchy) for details.

**Critical Pattern**: `disable_models_from_config()` must be called before importing the `inference` module to prevent loading disabled models.

## Application Layer (`app/`)

### Structure

**Sources**: [README.md40](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/README.md#L40-L40)

### Responsibilities

The `app/` module serves as the **orchestration layer**:

1. **Lifecycle Management**: Initializes all components in the correct order
2. **Signal Handling**: Registers SIGINT/SIGTERM handlers for graceful shutdown
3. **Component Integration**: Connects Control Plane, Data Plane, and Inference Pipeline
4. **Error Handling**: Manages exceptions and cleanup

**Key Class**: `InferencePipelineController` in [app/controller.py](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/app/controller.py)

This controller is the **single entry point** for starting the entire system. It owns all other components and orchestrates their interactions.

**Sources**: [adeline/__init__.py28](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/__init__.py#L28-L28)

## Control Plane (`control/`)

### Structure

**Sources**: [README.md41](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/README.md#L41-L41) [adeline/control/__init__.py1-6](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/__init__.py#L1-L6)

### Responsibilities

The `control/` module implements the **Control Plane (QoS 1)**:

1. **Command Reception**: Subscribes to `inference/control/commands` topic
2. **Callback Dispatch**: Routes commands to registered callbacks
3. **Status Publishing**: Publishes status to `inference/control/status` topic
4. **Reliable Delivery**: Uses MQTT QoS 1 for at-least-once delivery guarantees

**Key Files**:

- `plane.py`: `MQTTControlPlane` class - MQTT client and callback management
- `cli.py`: Command-line interface for sending control commands
- `__main__.py`: Entry point for `python -m adeline.control`

**Public Export**: Only `MQTTControlPlane` is exported from the module. The CLI functions are internal utilities accessed through the entry point.

**Sources**: [adeline/control/__init__.py1-6](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/__init__.py#L1-L6)

## Data Plane (`data/`)

### Structure

**Sources**: [README.md42](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/README.md#L42-L42)

### Responsibilities

The `data/` module implements the **Data Plane (QoS 0)**:

1. **Detection Publishing**: Publishes inference results to `inference/data/detections`
2. **Metrics Publishing**: Publishes performance metrics to `inference/data/metrics`
3. **Frame Publishing**: Optionally publishes annotated frames
4. **Monitoring Tools**: Provides subscribers to visualize data streams

**Key Files**:

- `plane.py`: `MQTTDataPlane` class - MQTT publishing with QoS 0
- `sinks.py`: Factory functions for creating MQTT sinks
- `monitors/`: Standalone monitoring tools (see [7.3](https://deepwiki.com/care-foundation/kata-inference-251021-clean2/7.3-monitoring-and-data-streams))

**Design Decision**: QoS 0 (best-effort delivery) prioritizes **throughput over reliability** for high-volume detection data. Lost detection messages are acceptable; control commands are not.

**Sources**: [README.md42](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/README.md#L42-L42)

## Inference Layer (`inference/`)

### Structure

**Sources**: [README.md43](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/README.md#L43-L43)

### Responsibilities

The `inference/` module contains **business logic for ML processing**:

1. **Model Management**: Loading, caching, and disabling models
2. **ROI Processing**: Region-of-interest cropping strategies (see [5.5](https://deepwiki.com/care-foundation/kata-inference-251021-clean2/5.5-roi-strategies))
3. **Detection Stabilization**: Temporal filtering to reduce flickering (see [5.6](https://deepwiki.com/care-foundation/kata-inference-251021-clean2/5.6-detection-stabilization))

**Factory Pattern**: Both `create_roi_strategy()` and `create_stabilization_strategy()` are factory functions that return strategy objects based on configuration.

**Key Insight**: This module is **configuration-driven but not configuration-aware**. Factory functions accept configuration parameters but don't load configuration files themselves, maintaining clean separation of concerns.

**Sources**: [README.md43](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/README.md#L43-L43)

## Visualization Layer (`visualization/`)

### Responsibilities

The `visualization/` module provides **OpenCV-based display sinks**:

1. **Frame Annotation**: Draws bounding boxes and labels on frames
2. **Window Display**: Shows real-time annotated video
3. **Sink Integration**: Implements the multi-sink pattern interface

**Key Function**: `create_visualization_sink()` - Returns a callable that can be used with the multi-sink pattern.

**Design Decision**: Visualization is **optional** and controlled by configuration. When disabled, no OpenCV windows are created, allowing headless operation.

**Sources**: [README.md44](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/README.md#L44-L44)

## Module Dependency Graph

**Dependency Principles**:

1. **Unidirectional Flow**: Dependencies flow downward from `app/` to `control/`, `data/`, `inference/`, and `visualization/`
2. **No Cross-Dependencies**: `control/`, `data/`, `inference/`, and `visualization/` do not depend on each other
3. **Callback Inversion**: `control/` calls back to `app/` through registered callbacks, not direct imports
4. **Configuration Centralization**: Only `app/controller.py` imports `config.py`

**Sources**: [adeline/__init__.py27-44](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/__init__.py#L27-L44)

## Entry Points and Module Access

The Adeline system has **three primary entry points**:

|Command|Entry Point File|Purpose|
|---|---|---|
|`python -m adeline`|[adeline/__main__.py](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/__main__.py)|Start main inference pipeline|
|`python -m adeline.control`|[adeline/control/__main__.py](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/__main__.py)|Send control commands via CLI|
|`python -m adeline.data.monitors`|[adeline/data/monitors/__main__.py](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/data/monitors/__main__.py)|Monitor data streams|

**Makefile Shortcuts**: The `Makefile` provides convenient shortcuts:

- `make run` → `python -m adeline`
- `make pause` → `python -m adeline.control` with pause command
- `make monitor-data` → `python -m adeline.data.monitors`

For detailed information about entry points, see [Entry Points](https://deepwiki.com/care-foundation/kata-inference-251021-clean2/8.2-entry-points).

**Sources**: [README.md78-102](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/README.md#L78-L102)

## Configuration and Infrastructure Separation

While Python code lives in `adeline/`, **configuration and infrastructure are externalized**:

### Configuration Files (`config/adeline/`)

```
config/adeline/
├── config.yaml              # Pipeline settings (ROI, stabilization, MQTT topics)
├── config.yaml.example      # Template for users
└── go2rtc.yaml             # RTSP proxy configuration
```

**Access Pattern**: `PipelineConfig` loads from `config/adeline/config.yaml` by default.

**Sources**: [README.md9-13](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/README.md#L9-L13)

### Infrastructure Files (`docker/adeline/`)

```
docker/adeline/
├── docker-compose.mqtt.yml  # MQTT broker service definition
└── mosquitto.conf          # Mosquitto broker configuration
```

**Access Pattern**: `make services-up` starts services defined in `docker-compose.mqtt.yml`.

**Sources**: [README.md15-18](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/README.md#L15-L18)

### Environment Variables (`.env`)

Sensitive credentials (API keys, MQTT passwords) are stored in `.env` at the project root, **not within the `adeline/` package**.

**Design Rationale**: This separation allows:

1. Different configurations per deployment without changing code
2. Versioning configuration separately from code
3. Sharing configuration templates (`.example` files) safely
4. Running multiple modules (e.g., future `cupertino/`) with isolated configs

**Sources**: [README.md48-49](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/README.md#L48-L49)

## Summary: Navigating the Codebase

To quickly locate functionality:

1. **Starting the system?** → [adeline/__main__.py](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/__main__.py) → [app/controller.py](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/app/controller.py)
2. **Control commands?** → [control/cli.py](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/control/cli.py) or [control/plane.py](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/control/plane.py)
3. **Data publishing?** → [data/plane.py](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/data/plane.py) or [data/sinks.py](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/data/sinks.py)
4. **ML logic?** → [inference/models.py](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/inference/models.py) [inference/roi/](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/inference/roi/) [inference/stabilization/](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/inference/stabilization/)
5. **Visualization?** → [visualization/sinks.py](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/visualization/sinks.py)
6. **Configuration?** → [config.py](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/config.py) then `config/adeline/config.yaml`
7. **Public API?** → [adeline/__init__.py](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/__init__.py)

**Sources**: [README.md5-52](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/README.md#L5-L52) [adeline/__init__.py1-44](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/__init__.py#L1-L44)