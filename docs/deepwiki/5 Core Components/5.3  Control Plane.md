# Control Plane

Relevant source files

- [adeline/CLAUDE.md](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md)
- [adeline/control/__init__.py](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/__init__.py)
- [adeline/control/plane.py](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py)

## Purpose and Scope

The Control Plane provides **reliable command delivery and pipeline lifecycle management** via MQTT. It implements QoS 1 (at-least-once delivery) to ensure critical operations like `pause`, `resume`, and `stop` are reliably delivered to the inference pipeline. The Control Plane subscribes to command topics, invokes registered callbacks, and publishes status updates.

This document covers the `MQTTControlPlane` class, its command handling architecture, callback system, and integration with the Pipeline Controller. For data publishing (detections, metrics), see [Data Plane](https://deepwiki.com/care-foundation/kata-inference-251021-clean2/5.4-data-plane). For overall system orchestration, see [Pipeline Controller](https://deepwiki.com/care-foundation/kata-inference-251021-clean2/5.1-pipeline-controller).

---

## Architecture Overview

The Control Plane is implemented as the `MQTTControlPlane` class in [adeline/control/plane.py](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py) It acts as a bridge between external MQTT clients (operators, CLI tools) and the inference pipeline's control logic.

### MQTTControlPlane Class Structure

**Sources:** [adeline/control/plane.py19-213](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L19-L213)

### Command Flow Architecture

The following diagram shows how commands flow from external clients through MQTT to the control plane callbacks:

**Sources:** [adeline/control/plane.py71-80](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L71-L80) [adeline/control/plane.py87-180](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L87-L180) [adeline/control/plane.py181-194](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L181-L194)

---

## Core Responsibilities

### 1. Command Subscription

On connection, the Control Plane subscribes to the command topic with **QoS 1** to ensure reliable delivery:

```
# From _on_connect callback
self.client.subscribe(self.command_topic, qos=1)
```

The default command topic is `"inference/control/commands"` but is configurable via constructor parameters.

**Sources:** [adeline/control/plane.py75](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L75-L75)

### 2. Command Handling

The `_on_message` callback receives all incoming commands and routes them to registered callbacks:

|Command|Callback|Action|Status Published|
|---|---|---|---|
|`pause`|`on_pause`|Pauses inference pipeline|`"paused"`|
|`resume`|`on_resume`|Resumes inference pipeline|`"running"`|
|`stop`|`on_stop`|Stops pipeline completely|`"stopped"`|
|`status`|None|Publishes current status|Current status|
|`metrics`|`on_metrics`|Publishes watchdog metrics via Data Plane|None|
|`toggle_crop`|`on_toggle_crop`|Toggles adaptive ROI on/off|None|
|`stabilization_stats`|`on_stabilization_stats`|Publishes detection stabilization stats|None|

**Command Format:**

```
{
  "command": "pause"
}
```

**Sources:** [adeline/control/plane.py23-30](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L23-L30) [adeline/control/plane.py87-180](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L87-L180)

### 3. Status Publishing

Status updates are published with **QoS 1** and **retain=True** to ensure:

- Reliable delivery of status changes
- New subscribers immediately receive last known status

```
def _publish_status(self, status: str):
    message = {
        "status": status,
        "timestamp": datetime.now().isoformat(),
        "client_id": self.client_id
    }
    self.client.publish(
        self.status_topic,
        json.dumps(message),
        qos=1,
        retain=True
    )
```

Status values: `"connected"`, `"paused"`, `"running"`, `"stopped"`, `"disconnected"`

**Sources:** [adeline/control/plane.py181-194](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L181-L194)

### 4. Connection Management

The Control Plane manages MQTT connection lifecycle with thread-safe connection tracking:

**Key Methods:**

- **`connect(timeout: float) -> bool`**: Connects to broker, starts loop thread, waits for connection event
- **`disconnect()`**: Publishes disconnected status, stops loop, disconnects client
- **`_on_connect()`**: Sets connection event, subscribes to commands, publishes connected status
- **`_on_disconnect()`**: Clears connection event, logs warning

**Sources:** [adeline/control/plane.py68-69](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L68-L69) [adeline/control/plane.py196-206](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L196-L206) [adeline/control/plane.py207-213](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L207-L213) [adeline/control/plane.py71-80](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L71-L80) [adeline/control/plane.py82-86](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L82-L86)

---

## Callback Registration Pattern

The Control Plane uses a **callback registration pattern** where the Pipeline Controller registers callbacks for each command type. Callbacks are optional; if not registered, a warning is logged.

### Callback Interface

```
# Callback types (all are Optional[Callable[[], None]])
self.on_stop: Optional[Callable[[], None]] = None
self.on_pause: Optional[Callable[[], None]] = None
self.on_resume: Optional[Callable[[], None]] = None
self.on_metrics: Optional[Callable[[], None]] = None
self.on_toggle_crop: Optional[Callable[[], None]] = None
self.on_stabilization_stats: Optional[Callable[[], None]] = None
```

### Callback Invocation with Error Handling

Each command handler wraps callback invocation with try-except blocks to prevent callback errors from crashing the control plane:

```
# Example: pause command handling
if self.on_pause:
    try:
        self.on_pause()
        self._publish_status("paused")
        logger.debug("✅ Comando PAUSE procesado")
    except Exception as e:
        logger.error(f"❌ Error en callback on_pause: {e}", exc_info=True)
else:
    logger.warning("⚠️ on_pause callback no configurado")
```

This pattern ensures that:

1. Callback errors are logged but don't crash the control plane
2. Missing callbacks trigger warnings rather than errors
3. Status is only published if callback succeeds

**Sources:** [adeline/control/plane.py51-57](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L51-L57) [adeline/control/plane.py98-108](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L98-L108)

---

## MQTT Configuration and QoS Strategy

### Constructor Parameters

```
def __init__(
    self,
    broker_host: str,
    broker_port: int = 1883,
    command_topic: str = "inference/control/commands",
    status_topic: str = "inference/control/status",
    client_id: str = "inference_control",
    username: Optional[str] = None,
    password: Optional[str] = None,
):
```

|Parameter|Default|Purpose|
|---|---|---|
|`broker_host`|Required|MQTT broker hostname (e.g., `"localhost"`)|
|`broker_port`|`1883`|MQTT broker port|
|`command_topic`|`"inference/control/commands"`|Topic for receiving commands|
|`status_topic`|`"inference/control/status"`|Topic for publishing status|
|`client_id`|`"inference_control"`|Unique identifier for this MQTT client|
|`username`|`None`|Optional MQTT authentication username|
|`password`|`None`|Optional MQTT authentication password|

**Sources:** [adeline/control/plane.py35-44](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L35-L44)

### QoS 1 Rationale

The Control Plane uses **QoS 1 (at-least-once delivery)** for all control operations:

**Why QoS 1:**

- **Command reliability**: `stop`, `pause`, and `resume` must not be lost
- **Status consistency**: Operators need accurate pipeline state
- **Low frequency**: Control commands are rare compared to data plane traffic
- **ACK confirmation**: Broker confirms message receipt before returning

**Sources:** [adeline/control/plane.py75](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L75-L75) [adeline/control/plane.py191-192](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L191-L192)

---

## Integration with Pipeline Controller

The Control Plane is instantiated and managed by the `InferencePipelineController`. The controller registers callbacks that directly manipulate the inference pipeline.

### Integration Pattern

**Typical Callback Registrations (from Pipeline Controller):**

```
# Pseudo-code from app/controller.py
control_plane.on_pause = lambda: self.pipeline.pause()
control_plane.on_resume = lambda: self.pipeline.resume()
control_plane.on_stop = lambda: self.stop_flag.set()
control_plane.on_metrics = lambda: self.data_plane.publish_metrics(self.watchdog_metrics)
control_plane.on_toggle_crop = lambda: self.roi_strategy.toggle_enabled()
control_plane.on_stabilization_stats = lambda: self.data_plane.publish_stabilization_stats(...)
```

**Sources:** [adeline/CLAUDE.md39-42](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L39-L42) [adeline/CLAUDE.md27-31](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L27-L31)

---

## Error Handling and Logging

The Control Plane implements comprehensive error handling and logging at multiple levels:

### Logging Levels

```
import logging
logger = logging.getLogger(__name__)
```

|Level|Use Case|Example|
|---|---|---|
|`INFO`|Connection events, command receipt, status publishing|`"✅ Control Plane conectado"`|
|`WARNING`|Missing callbacks, unknown commands, disconnections|`"⚠️ on_pause callback no configurado"`|
|`ERROR`|Connection failures, JSON decode errors, callback exceptions|`"❌ Error conectando a MQTT"`|
|`DEBUG`|Detailed message processing, callback execution flow|`"📝 Procesando comando PAUSE"`|

### Error Recovery Patterns

1. **JSON Decode Errors**: Log error, continue processing other messages
2. **Callback Exceptions**: Log with traceback, don't publish status, continue operation
3. **Connection Failures**: Return `False` from `connect()`, allow retry by caller
4. **Unknown Commands**: Log warning, ignore command

**Example Error Handling:**

```
try:
    payload = msg.payload.decode('utf-8')
    command_data = json.loads(payload)
    command = command_data.get('command', '').lower()
    # ... command processing
except json.JSONDecodeError:
    logger.error(f"❌ Error decodificando JSON: {msg.payload}")
except Exception as e:
    logger.error(f"❌ Error procesando mensaje: {e}")
```

**Sources:** [adeline/control/plane.py16](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L16-L16) [adeline/control/plane.py176-179](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L176-L179) [adeline/control/plane.py100-108](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L100-L108)

---

## Summary

The Control Plane provides the following key capabilities:

|Capability|Implementation|Quality of Service|
|---|---|---|
|**Command Receipt**|MQTT subscription to `inference/control/commands`|QoS 1 (reliable)|
|**Command Routing**|Callback pattern with error isolation|Exception-safe|
|**Status Publishing**|Retained messages to `inference/control/status`|QoS 1 + retain|
|**Connection Management**|Thread-safe event signaling|Timeout-based|
|**Callback Registration**|Optional callbacks with warnings|Graceful degradation|

The Control Plane is located at [adeline/control/plane.py](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py) and exports the `MQTTControlPlane` class via [adeline/control/__init__.py](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/__init__.py) It integrates with the Pipeline Controller (see [Pipeline Controller](https://deepwiki.com/care-foundation/kata-inference-251021-clean2/5.1-pipeline-controller)) for command execution and the Data Plane (see [Data Plane](https://deepwiki.com/care-foundation/kata-inference-251021-clean2/5.4-data-plane)) for metrics publishing.

**Sources:** [adeline/control/plane.py1-213](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L1-L213) [adeline/control/__init__.py1-7](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/__init__.py#L1-L7) [adeline/CLAUDE.md27-31](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L27-L31)