# ROI Strategies

Relevant source files

- [adeline/CLAUDE.md](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md)
- [adeline/DESIGN.md](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/DESIGN.md)
- [adeline/config.py](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/config.py)

## Purpose and Scope

This document describes the Region of Interest (ROI) processing system in the Adeline inference pipeline. ROI strategies allow selective processing of video frames by cropping to specific regions, reducing computational load and improving inference performance.

ROI strategies determine which portion of each video frame is sent to the YOLO model for object detection. The system supports three modes: **none** (full frame processing), **adaptive** (dynamic cropping based on detection history), and **fixed** (static region definition).

For information about detection stabilization after ROI processing, see [Detection Stabilization](https://deepwiki.com/care-foundation/kata-inference-251021-clean2/5.6-detection-stabilization). For model configuration, see [Model Management](https://deepwiki.com/care-foundation/kata-inference-251021-clean2/6.3-model-management).

---

## Overview

The ROI strategy system uses a **factory pattern** to create pluggable cropping behaviors that are selected at configuration time and can be toggled at runtime.

|Strategy Mode|Description|Use Case|
|---|---|---|
|**none**|No cropping; processes full frame|Maximum field of view, no performance optimization|
|**adaptive**|Dynamic crop following detected objects with temporal smoothing|Objects move predictably; reduces inference region dynamically|
|**fixed**|Static rectangular crop region|Objects always appear in known location; constant performance gain|

All strategies are created by the `create_roi_strategy()` factory function based on configuration settings. The factory pattern enables adding new ROI strategies without modifying existing pipeline code.

Sources: [adeline/CLAUDE.md58-62](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L58-L62) [adeline/DESIGN.md24-36](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/DESIGN.md#L24-L36)

---

## Factory Pattern Architecture

The ROI strategy system uses configuration-driven factory instantiation to decouple strategy selection from pipeline execution.

**Diagram: ROI Strategy Factory and Integration Flow**

The configuration system loads ROI settings from `config.yaml`, which are then passed to the factory function. The factory instantiates the appropriate strategy class based on `roi_strategy.mode`. The created strategy object is injected into the `InferencePipeline`, which calls it during frame processing.

Sources: [adeline/config.py150-206](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/config.py#L150-L206) [adeline/CLAUDE.md58-62](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L58-L62) [adeline/DESIGN.md24-36](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/DESIGN.md#L24-L36)

---

## Strategy Modes

### None Strategy

The **none** strategy performs no cropping and processes the entire video frame. This is the default mode when ROI processing is not needed.

**Behavior:**

- Passes full frame dimensions to inference
- No computational overhead
- Maximum field of view
- No configuration parameters required

**Configuration:**

```
roi_strategy:
  mode: none
```

**Use Cases:**

- Wide-area monitoring where all regions are equally important
- Initial system deployment before ROI optimization
- Baseline performance comparison

Sources: [adeline/config.py157](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/config.py#L157-L157) [adeline/CLAUDE.md59](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L59-L59)

---

### Adaptive Strategy

The **adaptive** strategy dynamically adjusts the crop region based on recent detection history, using temporal smoothing to avoid jitter.

**Behavior:**

1. Tracks bounding boxes from previous detections
2. Calculates minimum bounding box containing all recent detections
3. Expands box by configurable margin
4. Applies temporal smoothing (exponential moving average)
5. Constrains expansion rate using min/max ROI multiples
6. Feeds updated ROI coordinates back into pipeline

**Diagram: Adaptive ROI Feedback Loop**

**Configuration Parameters:**

|Parameter|Type|Default|Description|
|---|---|---|---|
|`margin`|float|0.2|Expansion factor around detected objects (20% larger)|
|`smoothing`|float|0.3|Temporal smoothing coefficient (α in EMA formula)|
|`min_roi_multiple`|int|1|Minimum ROI size as multiple of model input size|
|`max_roi_multiple`|int|4|Maximum ROI size as multiple of model input size|
|`show_statistics`|bool|true|Display ROI statistics on visualization|
|`resize_to_model`|bool|false|Resize cropped region to model input size|

**Configuration Example:**

```
roi_strategy:
  mode: adaptive
  adaptive:
    margin: 0.2
    smoothing: 0.3
    min_roi_multiple: 1
    max_roi_multiple: 4
    show_statistics: true
    resize_to_model: false
```

**Temporal Smoothing Formula:**

```
ROI(t) = α × ROI_calculated(t) + (1 - α) × ROI(t-1)
```

Where `α = smoothing` parameter (0.3 by default).

**Use Cases:**

- Objects moving within predictable regions
- Reducing inference load when objects occupy small portion of frame
- Tracking scenarios where detection history is available

**Limitations:**

- Requires detections to initialize (starts with full frame)
- May "chase" objects that move quickly out of frame
- Adds feedback loop complexity to pipeline

Sources: [adeline/config.py160-167](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/config.py#L160-L167) [adeline/CLAUDE.md60](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L60-L60)

---

### Fixed Strategy

The **fixed** strategy applies a static rectangular crop region defined by normalized coordinates.

**Behavior:**

1. Defines rectangular region using `(x_min, y_min)` and `(x_max, y_max)`
2. Coordinates are normalized (0.0 to 1.0) relative to frame dimensions
3. Crops every frame to this fixed region
4. Optionally displays overlay showing crop region
5. Consistent computational load across all frames

**Configuration Parameters:**

|Parameter|Type|Default|Description|
|---|---|---|---|
|`x_min`|float|0.2|Left edge of ROI (normalized 0.0-1.0)|
|`y_min`|float|0.2|Top edge of ROI (normalized 0.0-1.0)|
|`x_max`|float|0.8|Right edge of ROI (normalized 0.0-1.0)|
|`y_max`|float|0.8|Bottom edge of ROI (normalized 0.0-1.0)|
|`show_overlay`|bool|true|Display rectangle showing crop region|
|`resize_to_model`|bool|false|Resize cropped region to model input size|

**Configuration Example:**

```
roi_strategy:
  mode: fixed
  fixed:
    x_min: 0.2  # 20% from left
    y_min: 0.2  # 20% from top
    x_max: 0.8  # 80% from left (60% width)
    y_max: 0.8  # 80% from top (60% height)
    show_overlay: true
    resize_to_model: false
```

**Coordinate System:**

```
(0.0, 0.0) ────────────────── (1.0, 0.0)
    │                               │
    │    (x_min, y_min)             │
    │         ┌─────────┐           │
    │         │  ROI    │           │
    │         │ Region  │           │
    │         └─────────┘           │
    │              (x_max, y_max)   │
    │                               │
(0.0, 1.0) ────────────────── (1.0, 1.0)
```

**Use Cases:**

- Objects always appear in known location (e.g., doorway, counter)
- Consistent performance requirements
- Simplified testing and validation
- Excluding irrelevant background regions

**Limitations:**

- Cannot adapt to objects outside fixed region
- Requires prior knowledge of object locations
- May crop objects that move outside region

Sources: [adeline/config.py169-176](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/config.py#L169-L176)

---

## Configuration System

### Configuration Structure

ROI strategies are configured via the `roi_strategy` section in `config.yaml`. The system supports both a modern unified structure and legacy `adaptive_crop.enabled` syntax for backward compatibility.

**Modern Configuration Structure:**

```
roi_strategy:
  mode: "none" | "adaptive" | "fixed"  # Strategy selection
  
  # Adaptive-specific parameters
  adaptive:
    margin: 0.2
    smoothing: 0.3
    min_roi_multiple: 1
    max_roi_multiple: 4
    show_statistics: true
    resize_to_model: false
  
  # Fixed-specific parameters
  fixed:
    x_min: 0.2
    y_min: 0.2
    x_max: 0.8
    y_max: 0.8
    show_overlay: true
    resize_to_model: false
```

**Legacy Configuration (Backward Compatible):**

```
adaptive_crop:
  enabled: true  # Mapped to roi_strategy.mode: "adaptive"
  margin: 0.2
  smoothing: 0.3
  # ... other adaptive parameters
```

When legacy configuration is detected, the system logs a warning and automatically converts it to the modern structure:

```
⚠️ Using legacy 'adaptive_crop.enabled' config. 
Consider migrating to 'roi_strategy.mode' structure
```

Sources: [adeline/config.py150-206](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/config.py#L150-L206)

---

### Configuration Loading Flow

**Diagram: ROI Configuration Loading and Strategy Creation Sequence**

The `PipelineConfig` class in `config.py` loads the YAML configuration and exposes typed attributes that the factory function consumes. The factory pattern decouples configuration parsing from strategy instantiation.

Sources: [adeline/config.py150-206](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/config.py#L150-L206)

---

### Configuration Attributes

The `PipelineConfig` class exposes the following ROI-related attributes:

**Mode Selection:**

- `ROI_MODE: str` - Strategy mode: `"none"`, `"adaptive"`, or `"fixed"`

**Adaptive Strategy Parameters:**

- `CROP_MARGIN: float` - Expansion margin around detections
- `CROP_SMOOTHING: float` - Temporal smoothing coefficient
- `CROP_MIN_ROI_MULTIPLE: int` - Minimum ROI size multiple
- `CROP_MAX_ROI_MULTIPLE: int` - Maximum ROI size multiple
- `CROP_SHOW_STATISTICS: bool` - Display ROI statistics
- `ADAPTIVE_RESIZE_TO_MODEL: bool` - Resize cropped region to model size

**Fixed Strategy Parameters:**

- `FIXED_X_MIN: float` - Left edge (normalized)
- `FIXED_Y_MIN: float` - Top edge (normalized)
- `FIXED_X_MAX: float` - Right edge (normalized)
- `FIXED_Y_MAX: float` - Bottom edge (normalized)
- `FIXED_SHOW_OVERLAY: bool` - Display crop region overlay
- `FIXED_RESIZE_TO_MODEL: bool` - Resize cropped region to model size

These attributes are accessed by the factory function and passed to strategy constructors.

Sources: [adeline/config.py150-206](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/config.py#L150-L206)

---

## Runtime Control

### MQTT Command: toggle_crop

ROI strategies can be dynamically enabled or disabled at runtime using the `toggle_crop` MQTT command. This command is only functional when an ROI strategy (adaptive or fixed) is configured; it has no effect when `mode: none`.

**Command Format:**

```
{
  "command": "toggle_crop"
}
```

**Topic:**

```
inference/control/commands
```

**QoS:** 1 (Reliable delivery via Control Plane)

**Behavior:**

- **If ROI enabled:** Disables cropping and processes full frame
- **If ROI disabled:** Re-enables cropping with configured strategy
- **If `mode: none`:** No effect (already processing full frame)

**Command Execution via CLI:**

```
python -m adeline.control.cli toggle_crop
```

Or using Makefile:

```
make toggle-crop
```

**Diagram: Runtime ROI Toggle Control Flow**

The `toggle_crop` command flows through the Control Plane (QoS 1 for reliability) and invokes a callback registered by the `InferencePipelineController`. The callback toggles an internal flag that determines whether the active ROI strategy is applied during frame processing.

Sources: [adeline/CLAUDE.md12-14](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L12-L14) [adeline/CLAUDE.md62](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L62-L62)

---

## Pipeline Integration

### ROI Processing in Inference Flow

ROI strategies integrate into the inference pipeline as a pre-processing step before YOLO inference. The multi-sink pattern ensures that ROI state updates (for adaptive mode) occur after detection processing.

**Diagram: ROI Integration in Inference Pipeline Data Flow**

**Key Integration Points:**

1. **Pre-Inference:** ROI strategy runs before YOLO model, reducing input size
2. **Detection Output:** Bounding box coordinates are relative to cropped region
3. **Coordinate Transformation:** System converts cropped coordinates back to full frame
4. **ROI Update Sink:** Adaptive strategy receives feedback from detections via multi-sink
5. **Visualization:** Display shows both full frame and active ROI region

Sources: [adeline/CLAUDE.md113-121](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L113-L121) [adeline/DESIGN.md63-73](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/DESIGN.md#L63-L73)

---

### Multi-Sink Pattern for ROI Updates

The adaptive ROI strategy uses the **multi-sink pattern** to receive feedback from detection results without tight coupling to the inference pipeline.

**Sink Composition Example:**

```
from inference.core.interfaces.stream.sinks import multi_sink

pipeline.on_prediction = multi_sink(
    create_mqtt_sink(data_plane),       # Publish to MQTT
    create_visualization_sink(config),  # Display with OpenCV
    create_roi_update_sink(roi_state)   # Update adaptive ROI
)
```

The `create_roi_update_sink()` function creates a callback that:

1. Receives detection results for each frame
2. Extracts bounding box coordinates
3. Calculates new ROI region with margin and smoothing
4. Updates ROI state for next frame

This pattern enables ROI state updates without modifying the core inference loop, maintaining separation of concerns.

Sources: [adeline/CLAUDE.md113-121](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L113-L121) [adeline/DESIGN.md63-73](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/DESIGN.md#L63-L73)

---

## Design Rationale

### Factory Pattern for Extensibility

The ROI strategy system uses the factory pattern to enable adding new cropping algorithms without modifying existing code. New strategies only require:

1. Implementing a strategy interface (e.g., `ROIStrategy` abstract class)
2. Adding a new mode value to configuration schema
3. Extending the factory function with new mode branch

This design follows the **Open/Closed Principle**: open for extension, closed for modification.

**Example Extension:**

```
roi_strategy:
  mode: "tracking"  # New mode
  tracking:
    # New strategy-specific parameters
```

The factory function would add:

```
elif mode == "tracking":
    return TrackingROIStrategy(config.TRACKING_PARAM1, ...)
```

No changes required to pipeline, controller, or MQTT command handlers.

Sources: [adeline/DESIGN.md24-36](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/DESIGN.md#L24-L36) [adeline/DESIGN.md96-99](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/DESIGN.md#L96-L99)

---

### Configuration-Driven Behavior

ROI behavior is entirely controlled by configuration, not hardcoded logic. This enables:

- **Deployment Flexibility:** Different configurations for different camera positions
- **A/B Testing:** Compare performance with different ROI parameters
- **Zero-Code Changes:** Modify cropping behavior by editing YAML
- **Environment Portability:** Same codebase, different ROI strategies per deployment

The configuration-driven approach moves complexity from code to design, making the system more maintainable and adaptable.

Sources: [adeline/DESIGN.md38-50](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/DESIGN.md#L38-L50) [adeline/DESIGN.md100-103](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/DESIGN.md#L100-L103)

---

## Performance Considerations

### Computational Impact

ROI strategies affect pipeline performance in several ways:

**Inference Speedup:**

- Smaller input region → Fewer pixels for YOLO to process
- Speedup proportional to area reduction
- Example: 50% ROI size → ~4x fewer pixels → ~2-3x faster inference

**ROI Calculation Overhead:**

- **None:** Zero overhead
- **Fixed:** Negligible (constant coordinate lookup)
- **Adaptive:** Moderate (bounding box calculation, smoothing, constraints)

**Memory Usage:**

- Cropped frames use less memory during processing
- Adaptive strategy maintains ROI state history (minimal)

**Recommended Settings for Performance:**

```
roi_strategy:
  mode: adaptive
  adaptive:
    margin: 0.15          # Smaller margin = smaller ROI
    smoothing: 0.4        # Higher smoothing = less jitter (more stable)
    min_roi_multiple: 1   # Allow maximum ROI reduction
    max_roi_multiple: 2   # Prevent excessive expansion
```

### Trade-offs

|Aspect|None|Fixed|Adaptive|
|---|---|---|---|
|**Performance**|Baseline (100%)|Constant improvement|Variable improvement|
|**Accuracy**|Maximum coverage|May miss objects outside region|Adapts to object movement|
|**Complexity**|Minimal|Low|Moderate|
|**Configuration Effort**|None|Requires region knowledge|Requires parameter tuning|
|**Runtime Behavior**|Predictable|Predictable|Dynamic (may oscillate)|

Choose strategy based on application requirements: maximum coverage (none), known object locations (fixed), or dynamic optimization (adaptive).

Sources: [adeline/CLAUDE.md58-62](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L58-L62)