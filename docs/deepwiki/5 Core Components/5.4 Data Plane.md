# Data Plane

Relevant source files

- [adeline/CLAUDE.md](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md)
- [adeline/README.md](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/README.md)
- [adeline/app/controller.py](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/app/controller.py)

## Purpose and Scope

The Data Plane is responsible for publishing high-volume inference output data from the pipeline to external systems via MQTT. It handles detection results, performance metrics, and optional full-frame data using a QoS 0 (best-effort) delivery strategy optimized for throughput over guaranteed delivery.

This document covers the `MQTTDataPlane` class, data sink patterns, message formats, and monitoring tools. For command handling and pipeline control, see [Control Plane](https://deepwiki.com/care-foundation/kata-inference-251021-clean2/5.3-control-plane). For the overall orchestration that integrates both planes, see [Pipeline Controller](https://deepwiki.com/care-foundation/kata-inference-251021-clean2/5.1-pipeline-controller).

**Sources:** [adeline/CLAUDE.md33-37](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L33-L37) [adeline/README.md1-26](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/README.md#L1-L26)

---

## Architectural Role

The Data Plane operates independently from the Control Plane, following the control/data plane separation pattern. While the Control Plane handles low-frequency, critical commands with QoS 1, the Data Plane handles high-frequency data streams with QoS 0, prioritizing performance and minimizing latency.

**Sources:** [adeline/CLAUDE.md33-37](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L33-L37) [adeline/app/controller.py73-89](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/app/controller.py#L73-L89)

---

## MQTTDataPlane Class

The `MQTTDataPlane` class encapsulates all MQTT publishing logic for inference data. It maintains a persistent connection to the MQTT broker and provides methods for publishing detection results and metrics.

### Class Initialization

The class is instantiated in the Pipeline Controller with connection parameters and topic configurations:

[adeline/app/controller.py74-82](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/app/controller.py#L74-L82)

### Key Responsibilities

|Responsibility|Implementation|Method|
|---|---|---|
|Detection Publishing|Serialize and publish inference results|`publish_detection()`|
|Metrics Publishing|Publish watchdog performance metrics|`publish_metrics()`|
|Connection Management|Establish and maintain MQTT connection|`connect()`, `disconnect()`|
|Watchdog Integration|Link to metrics collection system|`set_watchdog()`|
|Statistics Tracking|Count published messages|`get_stats()`|

### Lifecycle Management

**Sources:** [adeline/app/controller.py73-89](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/app/controller.py#L73-L89) [adeline/app/controller.py369-372](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/app/controller.py#L369-L372)

---

## Sink Creation Pattern

The Data Plane uses a factory function to create MQTT sinks that integrate with the `inference` library's pipeline architecture. This enables seamless publishing of detection results through the multi-sink composition pattern.

### create_mqtt_sink Factory

The factory creates a closure that captures the `MQTTDataPlane` instance and returns a sink function compatible with the pipeline's callback interface:

[adeline/app/controller.py92](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/app/controller.py#L92-L92)

### Multi-Sink Composition

The MQTT sink is composed with other sinks using the `multi_sink` pattern, enabling parallel output to multiple destinations:

[adeline/app/controller.py214-234](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/app/controller.py#L214-L234)

For adaptive ROI mode, the sink list includes:

1. MQTT sink (detection publishing)
2. ROI update sink (feedback for dynamic cropping)
3. Visualization sink (optional, for display)

**Sources:** [adeline/app/controller.py92](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/app/controller.py#L92-L92) [adeline/app/controller.py214-234](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/app/controller.py#L214-L234) [adeline/CLAUDE.md113-121](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L113-L121)

---

## Message Formats

The Data Plane publishes two types of messages: detection results and performance metrics. Both use JSON serialization for interoperability.

### Detection Message Structure

Detection messages are published to `inference/data/detections` (configurable via `DATA_TOPIC`):

```
{
  "predictions": [
    {
      "x": 320.5,
      "y": 240.3,
      "width": 150.2,
      "height": 200.1,
      "confidence": 0.87,
      "class": "person",
      "class_id": 0
    }
  ],
  "frame_id": 1234,
  "time": 1698765432.123
}
```

### Metrics Message Structure

Metrics messages are published to `inference/data/metrics` (configurable via `METRICS_TOPIC`):

```
{
  "fps": 29.8,
  "latency_ms": 33.5,
  "inference_time_ms": 15.2,
  "frames_processed": 5432,
  "frames_dropped": 12,
  "timestamp": 1698765432.123
}
```

Metrics are collected from the `BasePipelineWatchDog` and published on-demand via the `METRICS` command or periodically if configured.

**Sources:** [adeline/app/controller.py74-82](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/app/controller.py#L74-L82) [adeline/app/controller.py367-372](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/app/controller.py#L367-L372)

---

## Watchdog Integration

The Data Plane integrates with the `BasePipelineWatchDog` to collect and publish performance metrics from the inference pipeline.

### Integration Sequence

1. **Initialization:** Controller creates watchdog instance [adeline/app/controller.py64](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/app/controller.py#L64-L64)
2. **Linking:** Controller calls `data_plane.set_watchdog(watchdog)` [adeline/app/controller.py89](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/app/controller.py#L89-L89)
3. **Pipeline Setup:** Watchdog is passed to pipeline during initialization [adeline/app/controller.py242-275](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/app/controller.py#L242-L275)
4. **Metrics Collection:** Watchdog accumulates frame processing statistics
5. **Publishing:** On `METRICS` command, data plane queries watchdog and publishes [adeline/app/controller.py367-372](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/app/controller.py#L367-L372)

**Sources:** [adeline/app/controller.py64](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/app/controller.py#L64-L64) [adeline/app/controller.py89](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/app/controller.py#L89-L89) [adeline/app/controller.py367-372](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/app/controller.py#L367-L372)

---

## QoS 0 Strategy Rationale

The Data Plane uses MQTT QoS 0 (at-most-once delivery) rather than QoS 1 (at-least-once) for strategic performance reasons.

### Performance vs Reliability Trade-off

|Aspect|QoS 0 (Data Plane)|QoS 1 (Control Plane)|
|---|---|---|
|Delivery Guarantee|Best-effort|At-least-once|
|Network Overhead|Minimal (no ACKs)|Higher (publish ACK)|
|Latency|Lower|Higher|
|Message Volume|High (30+ fps)|Low (occasional commands)|
|Message Criticality|Non-critical (next frame coming)|Critical (state changes)|

### Rationale

**Key Insight:** For real-time detection data at 30 FPS, if frame N is lost, frame N+1 arrives 33ms later with updated information, making guaranteed delivery unnecessary and potentially counterproductive.

**Sources:** [adeline/CLAUDE.md102-104](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L102-L104) [adeline/README.md5-6](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/README.md#L5-L6) [adeline/app/controller.py81](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/app/controller.py#L81-L81)

---

## Data Monitoring Tools

The `data/monitors/` module provides standalone MQTT subscribers for monitoring published data streams. These tools run independently of the main pipeline and consume messages for debugging, validation, and integration testing.

### Monitor Entry Point

### Usage Patterns

**Data Monitor (default):**

```
python -m adeline.data.monitors
# or explicitly
python -m adeline.data.monitors data
```

Displays detection messages from `inference/data/detections` in real-time.

**Status Monitor:**

```
python -m adeline.data.monitors status
```

Displays control plane status updates from `inference/control/status`.

### Makefile Integration

The Makefile provides convenience targets for monitoring:

```
make monitor-data    # Run data monitor
make monitor-status  # Run status monitor
```

**Sources:** [adeline/CLAUDE.md16-18](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L16-L18) [adeline/README.md3](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/README.md#L3-L3)

---

## Integration with Pipeline Controller

The Data Plane is orchestrated by the `InferencePipelineController`, which manages its lifecycle and coordinates it with other system components.

### Controller Responsibilities

### Error Handling

The controller implements error handling for Data Plane failures:

- **Connection failure:** Logged and setup aborted [adeline/app/controller.py84-86](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/app/controller.py#L84-L86)
- **Publishing errors:** Caught and logged without crashing pipeline
- **Disconnection:** Graceful cleanup with statistics reporting [adeline/app/controller.py514-518](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/app/controller.py#L514-L518)

**Sources:** [adeline/app/controller.py73-89](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/app/controller.py#L73-L89) [adeline/app/controller.py367-372](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/app/controller.py#L367-L372) [adeline/app/controller.py514-518](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/app/controller.py#L514-L518)

---

## Configuration Reference

Data Plane behavior is controlled through `config.yaml` settings and environment variables.

### Configuration Parameters

|Parameter|Type|Default|Description|
|---|---|---|---|
|`mqtt.broker`|string|`localhost`|MQTT broker hostname|
|`mqtt.port`|int|`1883`|MQTT broker port|
|`mqtt.data_topic`|string|`inference/data/detections`|Topic for detection results|
|`mqtt.metrics_topic`|string|`inference/data/metrics`|Topic for metrics|
|`mqtt.data_qos`|int|`0`|QoS level for data (0 recommended)|
|`MQTT_USERNAME`|env|-|Broker username (optional)|
|`MQTT_PASSWORD`|env|-|Broker password (optional)|

### Example Configuration

**config.yaml:**

```
mqtt:
  broker: localhost
  port: 1883
  data_topic: inference/data/detections
  metrics_topic: inference/data/metrics
  data_qos: 0
```

**.env:**

```
MQTT_USERNAME=inference_user
MQTT_PASSWORD=secure_password
```

**Sources:** [adeline/app/controller.py74-82](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/app/controller.py#L74-L82)

---

## Statistics and Observability

The Data Plane tracks operational statistics accessible through the `get_stats()` method.

### Available Metrics

```
stats = data_plane.get_stats()
# Returns:
# {
#     "messages_published": 15432,
#     "bytes_published": 2048576,
#     "connection_uptime": 3600.5,
#     "last_publish_time": 1698765432.123
# }
```

Statistics are logged during cleanup:

[adeline/app/controller.py515-516](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/app/controller.py#L515-L516)

This provides visibility into Data Plane performance and helps diagnose issues with message delivery or network connectivity.

**Sources:** [adeline/app/controller.py515-516](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/app/controller.py#L515-L516)