# Detection Stabilization

Relevant source files

- [adeline/CLAUDE.md](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md)
- [adeline/DESIGN.md](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/DESIGN.md)
- [adeline/config.py](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/config.py)

## Purpose and Scope

This document describes the detection stabilization subsystem in the Adeline inference pipeline. Detection stabilization reduces flickering and false positives in object detection output by applying temporal filtering and hysteresis thresholds to raw YOLO detections. This component sits between the YOLO inference engine and the output sinks, acting as optional middleware that stabilizes detection results across consecutive frames.

For information about the broader inference pipeline architecture, see [Inference Pipeline](https://deepwiki.com/care-foundation/kata-inference-251021-clean2/5.2-inference-pipeline). For ROI processing that occurs before detection, see [ROI Strategies](https://deepwiki.com/care-foundation/kata-inference-251021-clean2/5.5-roi-strategies).

---

## The Flickering Problem

Raw YOLO detection output can exhibit unstable behavior:

- **Intermittent Detections**: Objects detected in frames N and N+2 but missing in frame N+1
- **Confidence Oscillation**: Detection confidence fluctuating around threshold boundaries
- **False Positives**: Brief spurious detections lasting only 1-2 frames
- **Visual Noise**: Bounding boxes appearing/disappearing rapidly in visualization

These artifacts are especially problematic with:

- Fast/small models (e.g., YOLOv11n) trading accuracy for speed
- Low-resolution inference (e.g., 320x320 input size)
- Challenging lighting conditions or occlusions
- High frame rates where brief noise is more visible

Detection stabilization addresses these issues by requiring detections to persist across multiple frames before being reported.

**Sources:** [adeline/CLAUDE.md64-69](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L64-L69)

---

## Architecture: Factory Pattern and Strategies

Detection stabilization uses a factory pattern to enable runtime configuration of stabilization behavior without code changes.

### Factory Function

The `create_stabilization_strategy()` function in `inference/stabilization/core.py` creates strategy instances based on configuration:

```
def create_stabilization_strategy(config: PipelineConfig):
    """
    Factory function that creates stabilization strategy based on config.
    
    Returns:
        Stabilization strategy instance or None
    """
```

### Available Strategies

|Strategy|Mode Value|Description|Use Case|
|---|---|---|---|
|**None**|`"none"`|No stabilization, pass-through|High-accuracy models, static scenes|
|**Temporal + Hysteresis**|`"temporal"`|Requires N consecutive frames + dual thresholds|Fast models, dynamic scenes with noise|

The factory pattern enables adding new strategies (e.g., Kalman filtering, exponential smoothing) without modifying existing code.

**Sources:** [adeline/CLAUDE.md64-69](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L64-L69) [adeline/DESIGN.md31-34](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/DESIGN.md#L31-L34) [adeline/config.py133-147](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/config.py#L133-L147)

---

## Temporal + Hysteresis Strategy

The `temporal` stabilization mode combines two complementary techniques:

### 1. Temporal Filtering (Consecutive Frame Requirement)

Detections must appear in **N consecutive frames** before being confirmed:

- New detections enter a "candidate" state
- Candidate counter increments each frame the detection appears
- Detection becomes "stable" after reaching `min_frames` threshold
- Stable detections can tolerate `max_gap` frames of absence before removal

**Parameters:**

- `min_frames`: Number of consecutive frames required (default: 3)
- `max_gap`: Maximum consecutive frames a stable detection can be missing (default: 2)

### 2. Hysteresis Thresholds (Schmitt Trigger Pattern)

Two confidence thresholds prevent oscillation around a single boundary:

- **Appear Threshold** (`appear_confidence`): High threshold for new detections to appear (default: 0.5)
- **Persist Threshold** (`persist_confidence`): Lower threshold for existing detections to remain (default: 0.3)

This creates a "sticky" behavior where detections are hard to create but easy to maintain.

### Combined Behavior

**Diagram:** State machine for detection lifecycle with temporal+hysteresis stabilization

**Example Scenario:**

|Frame|Raw Confidence|State|Reason|
|---|---|---|---|
|1|0.45|Absent|Below appear_confidence (0.5)|
|2|0.55|Candidate (1/3)|Exceeds appear threshold|
|3|0.60|Candidate (2/3)|Still above appear threshold|
|4|0.52|Stable|Reached min_frames=3|
|5|0.35|Stable|Above persist_confidence (0.3)|
|6|Missing|Gap (1/2)|Tolerated absence|
|7|0.40|Stable|Reappeared, gap reset|
|8|0.25|Gap (1/2)|Below persist threshold|
|9|0.22|Gap (2/2)|Still below|
|10|Missing|Absent|Max gap exceeded|

**Sources:** [adeline/CLAUDE.md64-69](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L64-L69) [adeline/config.py133-147](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/config.py#L133-L147)

---

## Configuration

Detection stabilization is configured in `config.yaml` under the `detection_stabilization` section.

### Configuration Schema

```
detection_stabilization:
  mode: temporal  # Options: "none", "temporal"
  
  # Temporal filtering parameters
  temporal:
    min_frames: 3      # Consecutive frames to confirm detection
    max_gap: 2         # Max frames detection can be missing
  
  # Hysteresis threshold parameters
  hysteresis:
    appear_confidence: 0.5   # High threshold for new detections
    persist_confidence: 0.3  # Low threshold for existing detections
```

### Configuration Loading

The configuration is loaded into `PipelineConfig` attributes:

|Config Attribute|YAML Path|Default|Description|
|---|---|---|---|
|`STABILIZATION_MODE`|`detection_stabilization.mode`|`"none"`|Strategy selection|
|`STABILIZATION_MIN_FRAMES`|`detection_stabilization.temporal.min_frames`|`3`|Consecutive frames required|
|`STABILIZATION_MAX_GAP`|`detection_stabilization.temporal.max_gap`|`2`|Tolerated absence frames|
|`STABILIZATION_APPEAR_CONF`|`detection_stabilization.hysteresis.appear_confidence`|`0.5`|Appear threshold|
|`STABILIZATION_PERSIST_CONF`|`detection_stabilization.hysteresis.persist_confidence`|`0.3`|Persist threshold|

**Sources:** [adeline/config.py133-147](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/config.py#L133-L147)

---

## Parameter Tuning Guidelines

### Conservative Stabilization (Fewer False Positives)

```
temporal:
  min_frames: 5        # Stricter confirmation
  max_gap: 1           # Less tolerance for absence
hysteresis:
  appear_confidence: 0.6   # Higher entry bar
  persist_confidence: 0.4  # Higher exit bar
```

**Trade-off:** Higher latency (5 frames delay), may miss brief true positives.

### Aggressive Stabilization (Lower Latency)

```
temporal:
  min_frames: 2        # Faster confirmation
  max_gap: 3           # More tolerance for occlusion
hysteresis:
  appear_confidence: 0.4   # Lower entry bar
  persist_confidence: 0.2  # Lower exit bar
```

**Trade-off:** More false positives may pass through, but faster response.

### Balanced (Default)

```
temporal:
  min_frames: 3
  max_gap: 2
hysteresis:
  appear_confidence: 0.5
  persist_confidence: 0.3
```

**Sources:** [adeline/config.py140-147](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/config.py#L140-L147)

---

## Integration with Inference Pipeline

Detection stabilization sits in the inference pipeline data flow between raw YOLO output and multi-sink output.

**Diagram:** Detection stabilization in pipeline data flow

### Pipeline Controller Integration

The `InferencePipelineController` instantiates the stabilization strategy using the factory:

```
# In app/controller.py (conceptual, not actual code)
stabilization_strategy = create_stabilization_strategy(self.config)
pipeline.stabilization = stabilization_strategy
```

The pipeline applies stabilization before invoking sinks, ensuring all downstream consumers receive stabilized detections.

**Sources:** [adeline/CLAUDE.md64-69](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L64-L69) [adeline/DESIGN.md64-73](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/DESIGN.md#L64-L73)

---

## Runtime Monitoring: stabilization_stats Command

The control plane provides a `stabilization_stats` command to query stabilization state at runtime via MQTT.

### Command Format

**Topic:** `inference/control/commands` (QoS 1)

**Payload:**

```
{"command": "stabilization_stats"}
```

### Response Format

**Topic:** `inference/control/status` (QoS 1)

**Payload:**

```
{
  "status": "running",
  "stabilization": {
    "mode": "temporal",
    "tracked_objects": 5,
    "candidate_objects": 2,
    "stable_objects": 3,
    "parameters": {
      "min_frames": 3,
      "max_gap": 2,
      "appear_confidence": 0.5,
      "persist_confidence": 0.3
    }
  }
}
```

### Response Fields

|Field|Type|Description|
|---|---|---|
|`mode`|string|Current stabilization strategy (`"none"` or `"temporal"`)|
|`tracked_objects`|integer|Total objects being tracked (candidates + stable)|
|`candidate_objects`|integer|Objects in candidate state awaiting confirmation|
|`stable_objects`|integer|Objects that have reached stable state|
|`parameters`|object|Current configuration parameters|

### Usage Example

```
# Query stabilization stats using control CLI
python -m adeline.control stabilization_stats

# Or manually publish MQTT command
mosquitto_pub -h localhost -t inference/control/commands \
  -m '{"command": "stabilization_stats"}' -q 1

# Subscribe to status to see response
mosquitto_sub -h localhost -t inference/control/status -q 1
```

**Sources:** [adeline/CLAUDE.md29](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L29-L29) [adeline/CLAUDE.md69](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L69-L69)

---

## Strategy State Management

The temporal+hysteresis strategy maintains internal state for each tracked object:

**Diagram:** Internal state maintained by TemporalHysteresisStabilizer

### Object Matching

Objects are matched across frames using:

1. **Class Consistency**: Only match objects with same class label
2. **Spatial Proximity**: IoU (Intersection over Union) between bounding boxes
3. **Confidence Similarity**: Confidence difference within tolerance

This ensures the same physical object is tracked across frames despite minor position/confidence variations.

**Sources:** [adeline/CLAUDE.md64-69](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L64-L69)

---

## Disabling Stabilization

To disable stabilization and use raw YOLO output directly:

### Configuration

```
detection_stabilization:
  mode: none  # Disables stabilization
```

### Effect

When `mode: none`, the factory returns `None`, and the pipeline passes raw detections directly to sinks without any filtering. This is useful for:

- High-accuracy models that don't need stabilization
- Debugging to see raw model behavior
- Scenarios where latency is critical (stabilization adds `min_frames` delay)
- Testing to isolate stabilization effects

**Sources:** [adeline/config.py137](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/config.py#L137-L137)

---

## Performance Considerations

### Memory Overhead

The stabilization strategy maintains state for all tracked objects:

- **Per-object state:** ~200 bytes (ID, class, counters, bbox, confidence)
- **Typical scenario:** 10-20 tracked objects = ~2-4 KB
- **Extreme scenario:** 100 tracked objects = ~20 KB

Memory overhead is negligible compared to model inference.

### Computational Overhead

- **IoU calculation:** O(N×M) where N = current detections, M = tracked objects
- **Typical frame:** 5 detections × 10 tracked = 50 IoU calculations
- **Overhead:** <1ms per frame on modern CPUs

Computational cost is minimal compared to YOLO inference (50-200ms).

### Latency Impact

Stabilization introduces deterministic latency:

- **Latency:** `min_frames` × frame interval
- **Example:** min_frames=3, fps=2 → 1.5 second delay for new detections
- **Mitigation:** Use lower `min_frames` for latency-sensitive applications

**Sources:** [adeline/config.py140-142](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/config.py#L140-L142)

---

## Code Organization

The stabilization subsystem is organized under `inference/stabilization/`:

|File|Purpose|
|---|---|
|`inference/stabilization/core.py`|Factory function `create_stabilization_strategy()`|
|`inference/stabilization/temporal.py`|`TemporalHysteresisStabilizer` implementation (implied)|
|`inference/stabilization/__init__.py`|Public API exports|

The factory pattern follows the same structure as ROI strategies (see [ROI Strategies](https://deepwiki.com/care-foundation/kata-inference-251021-clean2/5.5-roi-strategies)).

**Sources:** [adeline/CLAUDE.md64](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L64-L64) [adeline/CLAUDE.md124-125](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L124-L125)

---

## Summary

Detection stabilization reduces flickering in YOLO output through:

1. **Factory Pattern**: Configuration-driven strategy selection
2. **Temporal Filtering**: Require N consecutive frames for confirmation
3. **Hysteresis Thresholds**: Dual confidence thresholds prevent oscillation
4. **Runtime Monitoring**: Query stats via MQTT `stabilization_stats` command
5. **Integration**: Middleware between YOLO inference and multi-sink output

The temporal+hysteresis strategy is particularly effective for fast models and dynamic scenes where raw detection output exhibits instability. Configuration parameters can be tuned to balance latency, false positives, and responsiveness based on application requirements.

**Sources:** [adeline/CLAUDE.md64-69](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L64-L69) [adeline/DESIGN.md31-34](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/DESIGN.md#L31-L34) [adeline/config.py133-147](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/config.py#L133-L147)