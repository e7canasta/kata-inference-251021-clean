# MQTT Communication Architecture

Relevant source files

- [README.md](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/README.md)
- [adeline/CLAUDE.md](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md)
- [adeline/control/plane.py](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py)

## Purpose and Scope

This document describes the MQTT communication layer that enables distributed control and monitoring of the Adeline inference system. It covers the MQTT broker integration, topic structure, Quality of Service (QoS) strategies, message formats, and connection management patterns.

For information about the architectural separation between control and data planes, see [Control and Data Plane Separation](https://deepwiki.com/care-foundation/kata-inference-251021-clean2/3.1-control-and-data-plane-separation). For details on specific control commands and their handlers, see [Control Plane](https://deepwiki.com/care-foundation/kata-inference-251021-clean2/5.3-control-plane) and [Data Plane](https://deepwiki.com/care-foundation/kata-inference-251021-clean2/5.4-data-plane).

## MQTT Broker Integration

The system uses **Mosquitto** as the MQTT broker, running as a Docker container on `localhost:1883`. The broker acts as the central message hub, decoupling the inference pipeline from control clients and monitoring systems.

### Broker Configuration

The Mosquitto broker is configured through `docker/adeline/docker-compose.mqtt.yml` and `docker/adeline/mosquitto.conf`. The broker provides:

- **Port**: 1883 (MQTT protocol)
- **Protocol**: MQTTv5
- **Authentication**: Username/password (configured in `.env`)
- **Persistence**: Message persistence for QoS 1 messages
- **Keep-alive**: 60-second heartbeat

### Client Connections

The system establishes two separate MQTT client connections:

|Client ID|Component|Purpose|QoS Strategy|
|---|---|---|---|
|`inference_control`|`MQTTControlPlane`|Command reception and status publishing|QoS 1 (reliable)|
|`inference_data`|`MQTTDataPlane`|Detection and metrics publishing|QoS 0 (performance)|

This dual-client architecture ensures that high-volume data publishing does not interfere with critical command delivery.

**Sources:** [adeline/control/plane.py19-213](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L19-L213) [adeline/CLAUDE.md22-43](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L22-L43) [README.md198-199](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/README.md#L198-L199)

## Topic Structure

The topic hierarchy follows a clear separation between control and data concerns:

### Topic Definitions

|Topic|Direction|QoS|Purpose|Retained|
|---|---|---|---|---|
|`inference/control/commands`|Inbound|1|Receive control commands (pause/resume/stop/status/metrics/toggle_crop/stabilization_stats)|No|
|`inference/control/status`|Outbound|1|Publish pipeline status (connected/running/paused/stopped/disconnected)|Yes|
|`inference/data/detections`|Outbound|0|Publish YOLO detection results|No|
|`inference/data/metrics`|Outbound|0|Publish watchdog performance metrics|No|
|`inference/data/full_frames`|Outbound|0|Publish annotated frames (optional)|No|

The `inference/control/status` topic uses the **retain flag** to ensure new subscribers immediately receive the last known pipeline state without waiting for the next status update.

**Sources:** [adeline/control/plane.py39-48](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L39-L48) [adeline/CLAUDE.md27-37](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L27-L37)

## QoS Strategy Rationale

The system uses different Quality of Service levels for control and data planes based on delivery requirements:

### QoS 1 (Control Plane)

**Rationale**: Control commands must be delivered reliably. A missed `stop` command could leave the pipeline running indefinitely, wasting resources. QoS 1 guarantees at-least-once delivery with publisher acknowledgment.

### QoS 0 (Data Plane)

**Rationale**: Detection data is high-volume and time-sensitive. A missed detection frame is acceptable since the next frame arrives in ~33ms (at 30 FPS). QoS 0 minimizes network overhead and latency, prioritizing throughput over guaranteed delivery.

**Trade-off**: Some detection messages may be lost during network congestion, but this does not impact system correctness—only observability.

**Sources:** [adeline/CLAUDE.md102-104](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L102-L104) [adeline/control/plane.py75](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L75-L75)

## Message Flow Patterns

### Command Processing Flow

**Key Implementation Details**:

- Commands are extracted from JSON payload: `command_data.get('command', '').lower()` [adeline/control/plane.py94](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L94-L94)
- Callbacks are invoked conditionally: `if self.on_pause: self.on_pause()` [adeline/control/plane.py100-102](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L100-L102)
- Status is published after successful command execution: `self._publish_status("paused")` [adeline/control/plane.py103](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L103-L103)

### Detection Publishing Flow

**Performance Optimization**: QoS 0 eliminates the acknowledgment roundtrip, reducing publish latency from ~20ms (QoS 1) to ~2ms (QoS 0) on localhost.

**Sources:** [adeline/control/plane.py87-179](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L87-L179) [adeline/CLAUDE.md114-121](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L114-L121)

## Connection Management

### Connection Lifecycle

Both control and data plane clients follow the same connection lifecycle pattern:

### Connection Implementation

The `MQTTControlPlane` class implements connection management with synchronization primitives:

**Connection Attributes** [adeline/control/plane.py59-69](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L59-L69):

- `self.client`: Paho MQTT client instance (MQTTv5)
- `self._connected`: `threading.Event` for connection synchronization
- `self._running`: Boolean flag for pipeline state tracking

**Connection Method** [adeline/control/plane.py196-205](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L196-L205):

```
def connect(self, timeout: float = 5.0) -> bool:
    """Conecta al broker MQTT"""
    self.client.connect(self.broker_host, self.broker_port, keepalive=60)
    self.client.loop_start()
    return self._connected.wait(timeout=timeout)
```

The `_connected.wait()` blocks until the `_on_connect` callback sets the event, providing synchronous connection semantics despite the asynchronous MQTT client.

### Reconnection Strategy

The Paho MQTT client automatically handles reconnection on network failures. The system does not implement custom reconnection logic, relying on the client's built-in exponential backoff.

**Sources:** [adeline/control/plane.py196-213](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L196-L213) [adeline/control/plane.py71-86](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L71-L86)

## Authentication and Security

### Credential Management

MQTT credentials are stored in the `.env` file and loaded through the configuration system:

**Environment Variables**:

- `MQTT_USERNAME`: Broker authentication username
- `MQTT_PASSWORD`: Broker authentication password

**Client Configuration** [adeline/control/plane.py60-62](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L60-L62):

```
if username and password:
    self.client.username_pw_set(username, password)
```

### Security Considerations

The current implementation uses unencrypted MQTT (port 1883) suitable for localhost deployment:

|Security Feature|Status|Notes|
|---|---|---|
|TLS/SSL Encryption|Not implemented|Traffic is unencrypted on localhost|
|Username/Password Auth|Implemented|Basic authentication enabled|
|Client Certificates|Not implemented|Not required for local deployment|
|ACL (Access Control Lists)|Not configured|All authenticated clients have full access|

**Deployment Consideration**: For production deployments exposing MQTT over the network, enable TLS (port 8883) and configure Mosquitto ACLs to restrict topic access by client ID.

**Sources:** [adeline/control/plane.py35-44](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L35-L44) [README.md48-49](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/README.md#L48-L49)

## Message Formats

### Control Command Format

All control commands follow a JSON structure with a single `command` field:

```
{
  "command": "pause" | "resume" | "stop" | "status" | "metrics" | "toggle_crop" | "stabilization_stats"
}
```

**Parsing** [adeline/control/plane.py91-94](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L91-L94):

```
payload = msg.payload.decode('utf-8')
command_data = json.loads(payload)
command = command_data.get('command', '').lower()
```

### Status Message Format

Status messages include timestamp and client identification:

```
{
  "status": "connected" | "running" | "paused" | "stopped" | "disconnected",
  "timestamp": "2024-01-15T10:30:00.123456",
  "client_id": "inference_control"
}
```

**Publishing** [adeline/control/plane.py181-194](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L181-L194):

```
message = {
    "status": status,
    "timestamp": datetime.now().isoformat(),
    "client_id": self.client_id
}
self.client.publish(
    self.status_topic,
    json.dumps(message),
    qos=1,
    retain=True
)
```

The `retain=True` flag ensures the last status is available to new subscribers immediately.

**Sources:** [adeline/control/plane.py181-194](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L181-L194) [adeline/CLAUDE.md128-130](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L128-L130)

## Client Registration and Topic Subscriptions

### Control Plane Client

**Client ID**: `inference_control` [adeline/control/plane.py41](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L41-L41)

**Subscribed Topics**:

- `inference/control/commands` (QoS 1) [adeline/control/plane.py75](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L75-L75)

**Published Topics**:

- `inference/control/status` (QoS 1, retained) [adeline/control/plane.py48](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L48-L48)

### Data Plane Client

**Client ID**: `inference_data`

**Published Topics**:

- `inference/data/detections` (QoS 0)
- `inference/data/metrics` (QoS 0)
- `inference/data/full_frames` (QoS 0, optional)

### Monitoring Clients

Monitoring tools subscribe to data topics without publishing:

Monitors use separate client IDs to avoid session conflicts and can run concurrently with the main pipeline.

**Sources:** [adeline/CLAUDE.md15-18](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L15-L18) [README.md93-102](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/README.md#L93-L102)

## Error Handling and Resilience

### Connection Error Handling

The control plane implements defensive error handling in the connection callback:

**Connection Callback** [adeline/control/plane.py71-80](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L71-L80):

```
def _on_connect(self, client, userdata, flags, rc, properties=None):
    if rc == 0:
        logger.info(f"✅ Control Plane conectado a {self.broker_host}:{self.broker_port}")
        self.client.subscribe(self.command_topic, qos=1)
        self._connected.set()
        self._publish_status("connected")
    else:
        logger.error(f"❌ Error conectando al broker MQTT: {rc}")
```

**Return Codes**:

- `0`: Connection successful
- `1`: Protocol version refused
- `2`: Client identifier rejected
- `3`: Server unavailable
- `4`: Bad username or password
- `5`: Not authorized

### Command Processing Error Handling

Each command callback is wrapped in try-except to prevent one failing command from crashing the message loop:

**Error Isolation** [adeline/control/plane.py100-108](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L100-L108):

```
if self.on_pause:
    try:
        self.on_pause()
        self._publish_status("paused")
    except Exception as e:
        logger.error(f"❌ Error en callback on_pause: {e}", exc_info=True)
```

This pattern ensures that a bug in a command handler does not break MQTT message processing.

### Disconnection Handling

The disconnection callback logs the event and clears the connection flag:

**Disconnection Callback** [adeline/control/plane.py82-85](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L82-L85):

```
def _on_disconnect(self, client, userdata, rc, properties=None):
    logger.warning(f"⚠️ Control Plane desconectado (rc={rc})")
    self._connected.clear()
```

The Paho client automatically attempts reconnection, so no manual reconnection logic is needed.

**Sources:** [adeline/control/plane.py71-85](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L71-L85) [adeline/control/plane.py100-179](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L100-L179)

## Integration with Pipeline Controller

The `InferencePipelineController` bridges MQTT control plane with pipeline operations:

The controller assigns callback functions that implement the actual pipeline control logic. The control plane remains agnostic to pipeline implementation details.

**Sources:** [adeline/CLAUDE.md39-42](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/CLAUDE.md#L39-L42) [adeline/control/plane.py52-57](https://github.com/care-foundation/kata-inference-251021-clean2/blob/9a713ffb/adeline/control/plane.py#L52-L57)